{% extends "base.html" %}

{% block content %}
<!-- Header do Dashboard de An√°lise -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-primary-custom text-white">
            <div class="card-body text-center py-4">
                <h1 class="display-5 mb-2">üìä An√°lise de Vendas - Evento 2025</h1>
                <p class="lead mb-0">Dashboard completo com m√©tricas de vendas, capilaridade e an√°lise por marca</p>
            </div>
        </div>
    </div>
</div>

<!-- Painel de Filtros -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">üîç Filtros de An√°lise</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label">Cliente</label>
                        <select class="form-select" id="filtroCliente">
                            <option value="todos">Todos os Clientes</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente }}">{{ cliente }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label">Vendedor</label>
                        <select class="form-select" id="filtroVendedor">
                            <option value="todos">Todos os Vendedores</option>
                            {% for vendedor in vendedores %}
                            <option value="{{ vendedor }}">{{ vendedor }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label">Marca</label>
                        <select class="form-select" id="filtroMarca">
                            <option value="todos">Todas as Marcas</option>
                            {% for marca in marcas %}
                            <option value="{{ marca }}">{{ marca }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label">Equipe</label>
                        <select class="form-select" id="filtroEquipe">
                            <option value="todos">Todas as Equipes</option>
                            {% for equipe in equipes %}
                            <option value="{{ equipe }}">{{ equipe }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label">Fam√≠lia</label>
                        <select class="form-select" id="filtroFamilia">
                            <option value="todos">Todas as Fam√≠lias</option>
                            {% for familia in familias %}
                            <option value="{{ familia }}">{{ familia }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label">Data In√≠cio</label>
                        <input type="date" class="form-control" id="filtroDataInicio" value="{{ min_date }}">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label">Data Fim</label>
                        <input type="date" class="form-control" id="filtroDataFim" value="{{ max_date }}">
                    </div>
                    <div class="col-lg-3 col-md-6 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="aplicarFiltros()">
                            üîÑ Aplicar Filtros
                        </button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-outline-primary" onclick="exportarParaExcel()">
                                üì• Exportar Excel
                            </button>
                            <button class="btn btn-outline-success" onclick="exportarParaPDF()">
                                üìä Exportar PDF/Imagem
                            </button>
                            <button class="btn btn-outline-secondary" onclick="resetarFiltros()">
                                üóëÔ∏è Limpar Filtros
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- M√©tricas Consolidadas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">üìà M√©tricas Consolidadas</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <!-- Total de Vendas (Valor) -->
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body py-3">
                                <h4 class="text-primary mb-1" id="totalValorVendas">R$ 0</h4>
                                <small class="text-muted">Total Vendas (Valor)</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total de NFs -->
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body py-3">
                                <h4 class="text-success mb-1" id="totalNFs">0</h4>
                                <small class="text-muted">Total de NFs</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total de Itens -->
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body py-3">
                                <h4 class="text-info mb-1" id="totalItens">0</h4>
                                <small class="text-muted">Total de Itens</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Consultor Top -->
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body py-3">
                                <h5 class="text-warning mb-1" id="topConsultor">N/A</h5>
                                <small class="text-muted">Consultor que mais vendeu (Valor)</small>
                                <div class="mt-1">
                                    <small id="topConsultorValor">R$ 0</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Revenda Top -->
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body py-3">
                                <h5 class="text-purple mb-1" id="topRevenda">N/A</h5>
                                <small class="text-muted">Revenda que mais comprou (Valor)</small>
                                <div class="mt-1">
                                    <small id="topRevendaValor">R$ 0</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Distribui√ß√£o por Marca -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="mb-3">üí∞ Distribui√ß√£o por Marca (Valor)</h6>
                        <div id="chartMarcas" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- An√°lise de Capilaridade -->
<div class="row mb-4">
    <!-- Capilaridade Geral -->
    <div class="col-lg-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">üåê Capilaridade Geral</h6>
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-4">
                        <h5 class="text-info" id="capClientes">0</h5>
                        <small class="text-muted">Clientes</small>
                    </div>
                    <div class="col-4">
                        <h5 class="text-success" id="capVendedores">0</h5>
                        <small class="text-muted">Vendedores</small>
                    </div>
                    <div class="col-4">
                        <h5 class="text-warning" id="capMarcas">0</h5>
                        <small class="text-muted">Marcas</small>
                    </div>
                </div>
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <h5 class="text-secondary" id="capMediaItensNF">0.0</h5>
                        <small class="text-muted">M√©dia Itens/NF</small>
                    </div>
                    <div class="col-6">
                        <h5 class="text-secondary" id="capMediaValorNF">R$ 0</h5>
                        <small class="text-muted">M√©dia Valor/NF</small>
                    </div>
                </div>
                <div id="chartCapilaridadeGeral" style="height: 200px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Capilaridade por Marca -->
    <div class="col-lg-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">üè∑Ô∏è Capilaridade por Marca</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Marca</th>
                                <th>NFs</th>
                                <th>Clientes</th>
                                <th>Vendedores</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaCapilaridadeMarca">
                            <!-- Dados ser√£o preenchidos via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- An√°lise Detalhada por Marca -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">üìä An√°lise por Marca</h6>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="selecionarMarca" onchange="carregarAnaliseMarca(this.value)">
                            <option value="">Selecione uma marca</option>
                            {% for marca in marcas %}
                            <option value="{{ marca }}">{{ marca }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- M√©tricas da Marca Selecionada -->
                <div class="row mb-4" id="metricasMarca">
                    <!-- Dados ser√£o preenchidos via JS -->
                </div>
                
                <div class="row">
                    <!-- Top Itens Vendidos -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">üèÜ Top Itens Vendidos</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Produto</th>
                                                <th>NFs</th>
                                                <th>Qtd</th>
                                                <th>Valor</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabelaTopItens">
                                            <!-- Dados ser√£o preenchidos via JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Consultores -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">üë• Top Consultores</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Consultor</th>
                                                <th>NFs</th>
                                                <th>Clientes</th>
                                                <th>Valor</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabelaTopConsultores">
                                            <!-- Dados ser√£o preenchidos via JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Top Clientes -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">üè¢ Top Clientes</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Cliente</th>
                                                <th>NFs</th>
                                                <th>Valor</th>
                                                <th>Ticket M√©dio</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabelaTopClientes">
                                            <!-- Dados ser√£o preenchidos via JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Distribui√ß√£o por Fam√≠lia -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">üì¶ Distribui√ß√£o por Fam√≠lia</h6>
                            </div>
                            <div class="card-body">
                                <div id="chartDistribuicaoFamilia" style="height: 250px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabela Detalhada de Vendas -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-dark text-white">
                <h6 class="mb-0">üìã Vendas Detalhadas</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="tabelaVendas">
                        <thead>
                            <tr>
                                <th>NF</th>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Vendedor</th>
                                <th>Equipe</th>
                                <th>Produto</th>
                                <th>Marca</th>
                                <th>Fam√≠lia</th>
                                <th>Qtd</th>
                                <th>Valor Unit.</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaVendas">
                            <!-- Dados ser√£o preenchidos via JS -->
                        </tbody>
                    </table>
                </div>
                <!-- Pagina√ß√£o -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <span class="me-2">Itens por p√°gina:</span>
                            <select class="form-select form-select-sm w-auto" id="itensPorPagina" onchange="carregarVendasFiltradas()">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <nav aria-label="Pagina√ß√£o">
                            <ul class="pagination justify-content-end" id="paginacao">
                                <!-- Pagina√ß√£o ser√° gerada via JS -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bot√£o Voltar -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <a href="{{ url_for('index') }}" class="btn btn-primary-custom btn-lg">
            üè† Voltar para P√°gina Inicial
        </a>
    </div>
</div>

<!-- Modal para Exporta√ß√£o -->
<div class="modal fade" id="modalExportacao" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üì§ Exportar Relat√≥rio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Formato de Exporta√ß√£o</label>
                    <select class="form-select" id="formatoExportacao">
                        <option value="excel">Excel (.xlsx)</option>
                        <option value="pdf">PDF Documento</option>
                        <option value="png">Imagem PNG</option>
                        <option value="jpg">Imagem JPG</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Qualidade da Imagem</label>
                    <select class="form-select" id="qualidadeImagem">
                        <option value="1">Baixa</option>
                        <option value="2">M√©dia</option>
                        <option value="3" selected>Alta</option>
                    </select>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="incluirFiltros">
                    <label class="form-check-label">Incluir configura√ß√µes de filtros</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarExportacao()">Exportar</button>
            </div>
        </div>
    </div>
</div>

<!-- Incluir Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// Vari√°veis globais
let vendasFiltradas = [];
let paginaAtual = 1;
let itensPorPagina = 50;
let graficoMarcas = null;
let graficoCapilaridadeGeral = null;
let graficoDistribuicaoFamilia = null;

// Inicializar dashboard
document.addEventListener('DOMContentLoaded', function() {
    carregarMetricasConsolidadas();
    carregarCapilaridade();
    carregarVendasFiltradas();
    
    // Atualizar automaticamente a cada 30 segundos
    setInterval(carregarMetricasConsolidadas, 30000);
    setInterval(carregarCapilaridade, 30000);
});

// Fun√ß√£o para aplicar filtros
function aplicarFiltros() {
    paginaAtual = 1;
    carregarMetricasConsolidadas();
    carregarCapilaridade();
    carregarVendasFiltradas();
}

// Fun√ß√£o para resetar filtros
function resetarFiltros() {
    document.getElementById('filtroCliente').value = 'todos';
    document.getElementById('filtroVendedor').value = 'todos';
    document.getElementById('filtroMarca').value = 'todos';
    document.getElementById('filtroEquipe').value = 'todos';
    document.getElementById('filtroFamilia').value = 'todos';
    document.getElementById('filtroDataInicio').value = '{{ min_date }}';
    document.getElementById('filtroDataFim').value = '{{ max_date }}';
    paginaAtual = 1;
    aplicarFiltros();
}

// Carregar m√©tricas consolidadas
function carregarMetricasConsolidadas() {
    const filtros = obterFiltros();
    
    fetch('/api/metricas-vendas-filtradas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(filtros)
    })
    .then(response => response.json())
    .then(data => {
        // Atualizar m√©tricas
        document.getElementById('totalValorVendas').textContent = 
            'R$ ' + (data.totais_por_nf?.total_valor || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
        document.getElementById('totalNFs').textContent = data.totais_por_nf?.total_nfs || 0;
        document.getElementById('totalItens').textContent = data.totais_por_nf?.total_itens || 0;
        
        // Top consultor
        if (data.vendedores?.maior_valor) {
            document.getElementById('topConsultor').textContent = data.vendedores.maior_valor.nome;
            document.getElementById('topConsultorValor').textContent = 
                'R$ ' + data.vendedores.maior_valor.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        }
        
        // Top revenda
        if (data.clientes?.maior_valor) {
            document.getElementById('topRevenda').textContent = data.clientes.maior_valor.nome;
            document.getElementById('topRevendaValor').textContent = 
                'R$ ' + data.clientes.maior_valor.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        }
        
        // Criar gr√°fico de marcas
        criarGraficoMarcas(data.marcas_por_nf || []);
    })
    .catch(error => {
        console.error('Erro ao carregar m√©tricas:', error);
    });
}

// Carregar capilaridade
function carregarCapilaridade() {
    const filtros = obterFiltros();
    
    fetch('/api/capilaridade-vendas-filtradas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(filtros)
    })
    .then(response => response.json())
    .then(data => {
        // Atualizar m√©tricas de capilaridade
        document.getElementById('capClientes').textContent = data.estatisticas_gerais?.total_clientes || 0;
        document.getElementById('capVendedores').textContent = data.estatisticas_gerais?.total_vendedores || 0;
        document.getElementById('capMarcas').textContent = data.estatisticas_gerais?.total_marcas || 0;
        document.getElementById('capMediaItensNF').textContent = 
            (data.estatisticas_gerais?.media_itens_por_nf || 0).toFixed(1);
        document.getElementById('capMediaValorNF').textContent = 
            'R$ ' + (data.estatisticas_gerais?.media_valor_por_nf || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
        
        // Atualizar tabela de capilaridade por marca
        atualizarTabelaCapilaridadeMarca(data.capilaridade_marca || []);
        
        // Criar gr√°fico de capilaridade geral
        criarGraficoCapilaridadeGeral(data);
    })
    .catch(error => {
        console.error('Erro ao carregar capilaridade:', error);
    });
}

// Carregar an√°lise de marca espec√≠fica
function carregarAnaliseMarca(marca) {
    if (!marca) return;
    
    fetch(`/api/analise-marca-filtrada/${marca}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(obterFiltros())
    })
    .then(response => response.json())
    .then(data => {
        // Atualizar m√©tricas da marca
        const metricasHtml = `
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-light border-0 h-100">
                    <div class="card-body text-center py-3">
                        <h5 class="text-primary mb-1">${data.dados_gerais?.total_nfs || 0}</h5>
                        <small class="text-muted">NFs da Marca</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-light border-0 h-100">
                    <div class="card-body text-center py-3">
                        <h5 class="text-success mb-1">R$ ${(data.dados_gerais?.total_valor || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h5>
                        <small class="text-muted">Valor Total</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-light border-0 h-100">
                    <div class="card-body text-center py-3">
                        <h5 class="text-warning mb-1">${data.dados_gerais?.total_quantidade || 0}</h5>
                        <small class="text-muted">Quantidade Total</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-light border-0 h-100">
                    <div class="card-body text-center py-3">
                        <h5 class="text-info mb-1">R$ ${(data.dados_gerais?.valor_medio_unitario || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h5>
                        <small class="text-muted">Ticket M√©dio</small>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('metricasMarca').innerHTML = metricasHtml;
        
        // Atualizar tabelas
        atualizarTabelaTopItens(data.top_produtos || []);
        atualizarTabelaTopConsultores(data.top_vendedores || []);
        atualizarTabelaTopClientes(data.top_clientes || []);
        
        // Criar gr√°fico de distribui√ß√£o por fam√≠lia
        criarGraficoDistribuicaoFamilia(data);
    })
    .catch(error => {
        console.error('Erro ao carregar an√°lise da marca:', error);
    });
}

// Carregar vendas filtradas
function carregarVendasFiltradas() {
    const filtros = obterFiltros();
    filtros.page = paginaAtual;
    filtros.per_page = parseInt(document.getElementById('itensPorPagina').value);
    
    fetch('/api/vendas-filtradas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(filtros)
    })
    .then(response => response.json())
    .then(data => {
        vendasFiltradas = data.vendas || [];
        
        // Atualizar tabela
        atualizarTabelaVendas(vendasFiltradas);
        
        // Atualizar pagina√ß√£o
        atualizarPaginacao(data.total_vendas || 0, data.page || 1, data.pages || 1);
    })
    .catch(error => {
        console.error('Erro ao carregar vendas filtradas:', error);
    });
}

// Obter filtros atuais
function obterFiltros() {
    return {
        cliente: document.getElementById('filtroCliente').value,
        vendedor: document.getElementById('filtroVendedor').value,
        marca: document.getElementById('filtroMarca').value,
        equipe: document.getElementById('filtroEquipe').value,
        familia: document.getElementById('filtroFamilia').value,
        data_inicio: document.getElementById('filtroDataInicio').value,
        data_fim: document.getElementById('filtroDataFim').value,
        sort_by: 'data_emissao',
        sort_order: 'desc'
    };
}

// Criar gr√°fico de marcas
function criarGraficoMarcas(dadosMarcas) {
    const ctx = document.getElementById('chartMarcas').getContext('2d');
    
    // Destruir gr√°fico anterior se existir
    if (graficoMarcas) {
        graficoMarcas.destroy();
    }
    
    // Preparar dados
    const labels = dadosMarcas.map(marca => marca.marca);
    const valores = dadosMarcas.map(marca => marca.valor);
    const cores = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
        '#FF9F40', '#8AC926', '#1982C4', '#6A4C93', '#F15BB5'
    ];
    
    graficoMarcas = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Valor por Marca (R$)',
                data: valores,
                backgroundColor: cores,
                borderColor: cores.map(cor => cor.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `R$ ${context.raw.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 0});
                        }
                    }
                }
            }
        }
    });
}

// Criar gr√°fico de capilaridade geral
function criarGraficoCapilaridadeGeral(data) {
    const ctx = document.getElementById('chartCapilaridadeGeral').getContext('2d');
    
    // Destruir gr√°fico anterior se existir
    if (graficoCapilaridadeGeral) {
        graficoCapilaridadeGeral.destroy();
    }
    
    // Preparar dados
    const labels = ['Clientes', 'Vendedores', 'Marcas', 'NFs'];
    const valores = [
        data.estatisticas_gerais?.total_clientes || 0,
        data.estatisticas_gerais?.total_vendedores || 0,
        data.estatisticas_gerais?.total_marcas || 0,
        data.estatisticas_gerais?.total_nfs || 0
    ];
    
    graficoCapilaridadeGeral = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Capilaridade',
                data: valores,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(54, 162, 235, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// Criar gr√°fico de distribui√ß√£o por fam√≠lia
function criarGraficoDistribuicaoFamilia(data) {
    const ctx = document.getElementById('chartDistribuicaoFamilia').getContext('2d');
    
    // Destruir gr√°fico anterior se existir
    if (graficoDistribuicaoFamilia) {
        graficoDistribuicaoFamilia.destroy();
    }
    
    // Agrupar por fam√≠lia (simulado - voc√™ precisar√° ajustar isso)
    const familias = {};
    data.top_produtos?.forEach(produto => {
        const familia = produto.familia || 'Sem Fam√≠lia';
        familias[familia] = (familias[familia] || 0) + produto.valor;
    });
    
    const labels = Object.keys(familias);
    const valores = Object.values(familias);
    
    graficoDistribuicaoFamilia = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: valores,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#8AC926', '#1982C4', '#6A4C93', '#F15BB5'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
}

// Atualizar tabela de capilaridade por marca
function atualizarTabelaCapilaridadeMarca(dados) {
    const tbody = document.getElementById('tabelaCapilaridadeMarca');
    let html = '';
    
    dados.slice(0, 10).forEach(marca => {
        html += `
            <tr>
                <td><strong>${marca.marca}</strong></td>
                <td>${marca.total_nfs}</td>
                <td>${marca.clientes_diferentes}</td>
                <td>${marca.vendedores_diferentes}</td>
                <td>R$ ${marca.valor_total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Atualizar tabela de top itens
function atualizarTabelaTopItens(dados) {
    const tbody = document.getElementById('tabelaTopItens');
    let html = '';
    
    dados.slice(0, 10).forEach(item => {
        html += `
            <tr>
                <td>${item.produto}</td>
                <td>${item.nfs}</td>
                <td>${item.quantidade}</td>
                <td>R$ ${item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Atualizar tabela de top consultores
function atualizarTabelaTopConsultores(dados) {
    const tbody = document.getElementById('tabelaTopConsultores');
    let html = '';
    
    dados.slice(0, 10).forEach(consultor => {
        html += `
            <tr>
                <td>${consultor.vendedor}</td>
                <td>${consultor.nfs}</td>
                <td>${consultor.clientes_atendidos}</td>
                <td>R$ ${consultor.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Atualizar tabela de top clientes
function atualizarTabelaTopClientes(dados) {
    const tbody = document.getElementById('tabelaTopClientes');
    let html = '';
    
    dados.slice(0, 10).forEach(cliente => {
        const ticketMedio = cliente.valor / cliente.nfs;
        html += `
            <tr>
                <td>${cliente.cliente}</td>
                <td>${cliente.nfs}</td>
                <td>R$ ${cliente.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td>R$ ${ticketMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Atualizar tabela de vendas
function atualizarTabelaVendas(dados) {
    const tbody = document.getElementById('corpoTabelaVendas');
    let html = '';
    
    dados.forEach(venda => {
        html += `
            <tr>
                <td>${venda.numero_nf}</td>
                <td>${venda.data_emissao}</td>
                <td>${venda.cliente_nome}</td>
                <td>${venda.vendedor}</td>
                <td>${venda.equipe}</td>
                <td>${venda.descricao_produto}</td>
                <td>${venda.marca}</td>
                <td>${venda.familia || 'N/A'}</td>
                <td>${venda.quantidade}</td>
                <td>R$ ${venda.valor_unitario.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td><strong>R$ ${venda.valor_total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Atualizar pagina√ß√£o
function atualizarPaginacao(total, pagina, totalPaginas) {
    const paginacao = document.getElementById('paginacao');
    let html = '';
    
    // Bot√£o anterior
    html += `
        <li class="page-item ${pagina === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="mudarPagina(${pagina - 1})">Anterior</a>
        </li>
    `;
    
    // P√°ginas
    const inicio = Math.max(1, pagina - 2);
    const fim = Math.min(totalPaginas, pagina + 2);
    
    for (let i = inicio; i <= fim; i++) {
        html += `
            <li class="page-item ${i === pagina ? 'active' : ''}">
                <a class="page-link" href="#" onclick="mudarPagina(${i})">${i}</a>
            </li>
        `;
    }
    
    // Bot√£o pr√≥ximo
    html += `
        <li class="page-item ${pagina === totalPaginas ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="mudarPagina(${pagina + 1})">Pr√≥ximo</a>
        </li>
    `;
    
    paginacao.innerHTML = html;
}

// Mudar p√°gina
function mudarPagina(novaPagina) {
    paginaAtual = novaPagina;
    carregarVendasFiltradas();
}

// Exportar para Excel
function exportarParaExcel() {
    const filtros = obterFiltros();
    const params = new URLSearchParams(filtros).toString();
    window.location.href = `/exportar-vendas-filtradas?${params}`;
}

// Exportar para PDF/Imagem
function exportarParaPDF() {
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalExportacao'));
    modal.show();
}

// Confirmar exporta√ß√£o
function confirmarExportacao() {
    const formato = document.getElementById('formatoExportacao').value;
    
    if (formato === 'excel') {
        exportarParaExcel();
    } else if (formato === 'pdf') {
        gerarPDF();
    } else {
        gerarImagem(formato);
    }
    
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalExportacao'));
    modal.hide();
}

// Gerar PDF
function gerarPDF() {
    // Implementa√ß√£o simplificada - voc√™ pode usar html2canvas + jsPDF
    html2canvas(document.querySelector(".card")).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        pdf.save('relatorio_vendas.pdf');
    });
}

// Gerar imagem
function gerarImagem(formato) {
    html2canvas(document.querySelector(".card")).then(canvas => {
        const link = document.createElement('a');
        link.download = `relatorio_vendas.${formato}`;
        link.href = canvas.toDataURL(`image/${formato}`);
        link.click();
    });
}

// Fun√ß√£o para atualizar itens por p√°gina
document.getElementById('itensPorPagina').addEventListener('change', function() {
    itensPorPagina = parseInt(this.value);
    paginaAtual = 1;
    carregarVendasFiltradas();
});
</script>

<style>
.card {
    border-radius: 12px;
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.bg-primary-custom {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.text-purple {
    color: #6f42c1 !important;
}

.table-hover tbody tr:hover {
    background-color: rgba(0,123,255,.1);
}

.table th {
    font-weight: 600;
    color: #495057;
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}

.form-select-sm {
    padding: .25rem .5rem;
    font-size: .875rem;
}

.page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.modal-content {
    border-radius: 12px;
    border: none;
}
</style>
{% endblock %}
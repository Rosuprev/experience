<!-- templates/analise_vendas.html -->
{% extends "base.html" %}

{% block content %}
<!-- Header do Dashboard de An√°lise -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-gradient-primary text-white shadow-lg">
            <div class="card-body d-flex align-items-center py-4">
                <div class="me-3">
                    <i class="fas fa-chart-bar fa-3x opacity-75"></i>
                </div>
                <div>
                    <h1 class="h2 mb-2 fw-bold">üìä An√°lise de Vendas Power BI</h1>
                    <p class="lead mb-0 opacity-90">Dashboard completo com an√°lise de vendas e m√©tricas de desempenho</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Linha de KPI Cards - Estilo Power BI -->
<div class="row mb-4">
    <div class="col-12">
        <div class="row g-3" id="kpiRow">
            <!-- KPI Cards ser√£o carregados via JavaScript -->
            <div class="col-xl-2 col-md-4 col-6">
                <div class="card kpi-card shadow-sm border-0" style="background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);">
                    <div class="card-body text-center p-3">
                        <div class="kpi-icon text-white mb-2">
                            <i class="fas fa-file-invoice fa-2x"></i>
                        </div>
                        <h3 class="kpi-value text-white mb-1">0</h3>
                        <p class="kpi-label text-white-50 mb-0">Total de NFs</p>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-2 col-md-4 col-6">
                <div class="card kpi-card shadow-sm border-0" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);">
                    <div class="card-body text-center p-3">
                        <div class="kpi-icon text-white mb-2">
                            <i class="fas fa-money-bill-wave fa-2x"></i>
                        </div>
                        <h3 class="kpi-value text-white mb-1">R$ 0</h3>
                        <p class="kpi-label text-white-50 mb-0">Valor Total</p>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-2 col-md-4 col-6">
                <div class="card kpi-card shadow-sm border-0" style="background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);">
                    <div class="card-body text-center p-3">
                        <div class="kpi-icon text-white mb-2">
                            <i class="fas fa-boxes fa-2x"></i>
                        </div>
                        <h3 class="kpi-value text-white mb-1">0</h3>
                        <p class="kpi-label text-white-50 mb-0">Itens Vendidos</p>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-2 col-md-4 col-6">
                <div class="card kpi-card shadow-sm border-0" style="background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);">
                    <div class="card-body text-center p-3">
                        <div class="kpi-icon text-white mb-2">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                        <h3 class="kpi-value text-white mb-1">0</h3>
                        <p class="kpi-label text-white-50 mb-0">Clientes √önicos</p>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-2 col-md-4 col-6">
                <div class="card kpi-card shadow-sm border-0" style="background: linear-gradient(135deg, #d35400 0%, #e67e22 100%);">
                    <div class="card-body text-center p-3">
                        <div class="kpi-icon text-white mb-2">
                            <i class="fas fa-shopping-cart fa-2x"></i>
                        </div>
                        <h3 class="kpi-value text-white mb-1">0</h3>
                        <p class="kpi-label text-white-50 mb-0">M√©dia Itens/NF</p>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-2 col-md-4 col-6">
                <div class="card kpi-card shadow-sm border-0" style="background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);">
                    <div class="card-body text-center p-3">
                        <div class="kpi-icon text-white mb-2">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                        <h3 class="kpi-value text-white mb-1">R$ 0</h3>
                        <p class="kpi-label text-white-50 mb-0">M√©dia Valor/NF</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros Sidebar + Conte√∫do Principal -->
<div class="row mb-4">
    <!-- Sidebar de Filtros -->
    <div class="col-lg-3 col-md-4 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-dark text-white py-3">
                <h6 class="mb-0 fw-bold"><i class="fas fa-filter me-2"></i>Filtros</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">CLIENTE</label>
                    <select class="form-select form-select-sm" id="filtroCliente">
                        <option value="todos">Todos os Clientes</option>
                        {% for cliente in clientes %}
                        <option value="{{ cliente }}">{{ cliente }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">VENDEDOR</label>
                    <select class="form-select form-select-sm" id="filtroVendedor">
                        <option value="todos">Todos os Vendedores</option>
                        {% for vendedor in vendedores %}
                        <option value="{{ vendedor }}">{{ vendedor }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">MARCA</label>
                    <select class="form-select form-select-sm" id="filtroMarca">
                        <option value="todos">Todas as Marcas</option>
                        {% for marca in marcas %}
                        <option value="{{ marca }}">{{ marca }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">EQUIPE</label>
                    <select class="form-select form-select-sm" id="filtroEquipe">
                        <option value="todos">Todas as Equipes</option>
                        {% for equipe in equipes %}
                        <option value="{{ equipe }}">{{ equipe }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">FAM√çLIA</label>
                    <select class="form-select form-select-sm" id="filtroFamilia">
                        <option value="todos">Todas as Fam√≠lias</option>
                        {% for familia in familias %}
                        <option value="{{ familia }}">{{ familia }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">DATA IN√çCIO</label>
                    <input type="date" class="form-control form-control-sm" id="filtroDataInicio" 
                           value="{{ min_date.strftime('%Y-%m-%d') if min_date else '' }}">
                </div>
                
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">DATA FIM</label>
                    <input type="date" class="form-control form-control-sm" id="filtroDataFim"
                           value="{{ max_date.strftime('%Y-%m-%d') if max_date else '' }}">
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-sm fw-bold" id="btnAplicarFiltros">
                        <i class="fas fa-filter me-1"></i>Aplicar Filtros
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="btnLimparFiltros">
                        <i class="fas fa-times me-1"></i>Limpar Filtros
                    </button>
                    <button class="btn btn-success btn-sm fw-bold" id="btnExportarExcel">
                        <i class="fas fa-file-excel me-1"></i>Exportar Excel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Conte√∫do Principal -->
    <div class="col-lg-9 col-md-8">
        <!-- Top Performers -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card border-0 shadow-sm h-100 hover-lift">
                    <div class="card-header bg-gradient-success text-white py-3">
                        <h6 class="mb-0 fw-bold"><i class="fas fa-trophy me-2"></i>Maior Nota Fiscal</h6>
                    </div>
                    <div class="card-body text-center py-4" id="maiorNF">
                        <div class="placeholder-content">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <p class="text-muted">Carregando...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 mb-3">
                <div class="card border-0 shadow-sm h-100 hover-lift">
                    <div class="card-header bg-gradient-primary text-white py-3">
                        <h6 class="mb-0 fw-bold"><i class="fas fa-crown me-2"></i>Cliente Top</h6>
                    </div>
                    <div class="card-body text-center py-4" id="clienteTop">
                        <div class="placeholder-content">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <p class="text-muted">Carregando...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 mb-3">
                <div class="card border-0 shadow-sm h-100 hover-lift">
                    <div class="card-header bg-gradient-warning text-white py-3">
                        <h6 class="mb-0 fw-bold"><i class="fas fa-star me-2"></i>Vendedor Top</h6>
                    </div>
                    <div class="card-body text-center py-4" id="vendedorTop">
                        <div class="placeholder-content">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <p class="text-muted">Carregando...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- An√°lise de Capilaridade -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-gradient-dark text-white py-3">
                <h6 class="mb-0 fw-bold"><i class="fas fa-sitemap me-2"></i>An√°lise de Capilaridade</h6>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs nav-tabs-custom mb-3" id="capilaridadeTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-clientes" data-bs-toggle="tab" data-bs-target="#clientes-tab" type="button" role="tab">
                            <i class="fas fa-building me-1"></i> Por Cliente
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-vendedores" data-bs-toggle="tab" data-bs-target="#vendedores-tab" type="button" role="tab">
                            <i class="fas fa-user-tie me-1"></i> Por Vendedor
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-marcas" data-bs-toggle="tab" data-bs-target="#marcas-tab" type="button" role="tab">
                            <i class="fas fa-tag me-1"></i> Por Marca
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="capilaridadeContent">
                    <div class="tab-pane fade show active" id="clientes-tab" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm table-striped" id="tabelaClientes">
                                <thead class="table-light">
                                    <tr>
                                        <th>Cliente</th>
                                        <th class="text-end">NFs</th>
                                        <th class="text-end">Valor Total</th>
                                        <th class="text-end">Itens</th>
                                        <th class="text-end">Ticket M√©dio</th>
                                    </tr>
                                </thead>
                                <tbody id="corpoTabelaClientes">
                                    <tr>
                                        <td colspan="5" class="text-center py-4 text-muted">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            Carregando dados...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="vendedores-tab" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm table-striped" id="tabelaVendedores">
                                <thead class="table-light">
                                    <tr>
                                        <th>Vendedor</th>
                                        <th>Equipe</th>
                                        <th class="text-end">NFs</th>
                                        <th class="text-end">Clientes</th>
                                        <th class="text-end">Valor Total</th>
                                        <th class="text-end">Efici√™ncia</th>
                                    </tr>
                                </thead>
                                <tbody id="corpoTabelaVendedores">
                                    <tr>
                                        <td colspan="6" class="text-center py-4 text-muted">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            Carregando dados...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="marcas-tab" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm table-striped" id="tabelaMarcas">
                                <thead class="table-light">
                                    <tr>
                                        <th>Marca</th>
                                        <th class="text-end">NFs</th>
                                        <th class="text-end">Clientes</th>
                                        <th class="text-end">Valor Total</th>
                                        <th class="text-end">Participa√ß√£o</th>
                                        <th class="text-end">Penetra√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="corpoTabelaMarcas">
                                    <tr>
                                        <td colspan="6" class="text-center py-4 text-muted">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            Carregando dados...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabela Detalhada -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-gradient-dark text-white py-3">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-bold"><i class="fas fa-list me-2"></i>Vendas Detalhadas</h6>
            <div>
                <button class="btn btn-sm btn-light me-2" id="btnRecarregarDados">
                    <i class="fas fa-sync-alt me-1"></i>Atualizar
                </button>
                <span class="badge bg-light text-dark">
                    <i class="fas fa-database me-1"></i>
                    <span id="totalRegistros">0</span> registros
                </span>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover table-sm" id="tabelaVendas">
                <thead class="table-light">
                    <tr>
                        <th>NF</th>
                        <th>Data</th>
                        <th>Cliente</th>
                        <th>Vendedor</th>
                        <th>Equipe</th>
                        <th>Produto</th>
                        <th>Marca</th>
                        <th>Fam√≠lia</th>
                        <th class="text-end">Valor Unit.</th>
                        <th class="text-end">Quantidade</th>
                        <th class="text-end">Valor Total</th>
                    </tr>
                </thead>
                <tbody id="corpoTabelaVendas">
                    <tr>
                        <td colspan="11" class="text-center py-5 text-muted">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <p>Carregando vendas...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagina√ß√£o -->
        <nav aria-label="Pagina√ß√£o" id="paginacao" class="mt-3">
            <ul class="pagination pagination-sm justify-content-center">
                <li class="page-item disabled">
                    <a class="page-link" href="#">Anterior</a>
                </li>
                <li class="page-item active">
                    <a class="page-link" href="#">1</a>
                </li>
                <li class="page-item disabled">
                    <a class="page-link" href="#">Pr√≥xima</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- Scripts -->
<script>
// ========== FUN√á√ïES PRINCIPAIS ==========

async function carregarTodasMetricas() {
    try {
        await carregarMetricasGerais();
        await carregarCapilaridade();
        await carregarVendas(1);
    } catch (error) {
        console.error('Erro ao carregar m√©tricas:', error);
        mostrarErro('Erro ao carregar dados. Tente novamente.');
    }
}

async function carregarMetricasGerais() {
    try {
        const response = await fetch('/api/metricas-vendas');
        const data = await response.json();
        atualizarKPIs(data);
        atualizarTopPerformers(data);
    } catch (error) {
        console.error('Erro ao carregar m√©tricas gerais:', error);
    }
}

function atualizarKPIs(data) {
    // Atualizar KPI cards
    const kpiCards = document.querySelectorAll('.kpi-value');
    if (kpiCards.length >= 6) {
        kpiCards[0].textContent = data.totais_por_nf.total_nfs.toLocaleString('pt-BR');
        kpiCards[1].textContent = 'R$ ' + data.totais_por_nf.total_valor.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        kpiCards[2].textContent = data.totais_por_nf.total_itens.toLocaleString('pt-BR');
        kpiCards[3].textContent = data.estatisticas_gerais ? data.estatisticas_gerais.total_clientes.toLocaleString('pt-BR') : '0';
        kpiCards[4].textContent = data.totais_por_nf.media_itens_por_nf.toFixed(1);
        kpiCards[5].textContent = 'R$ ' + data.totais_por_nf.media_valor_por_nf.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    }
}

// (Manter todas as fun√ß√µes originais, apenas adicionar as novas de visualiza√ß√£o)

// ========== NOVAS FUN√á√ïES DE ESTILO ==========

function aplicarEfeitosPowerBI() {
    // Animar KPI cards
    const kpiCards = document.querySelectorAll('.kpi-card');
    kpiCards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate__animated', 'animate__fadeInUp');
    });
}

function mostrarErro(mensagem) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show';
    alertDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${mensagem}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container').prepend(alertDiv);
}

// ========== EVENT LISTENERS ==========

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar
    carregarTodasMetricas();
    aplicarEfeitosPowerBI();
    
    // Configurar eventos
    document.getElementById('btnAplicarFiltros').addEventListener('click', carregarTodasMetricas);
    document.getElementById('btnLimparFiltros').addEventListener('click', function() {
        document.getElementById('filtroCliente').value = 'todos';
        document.getElementById('filtroVendedor').value = 'todos';
        document.getElementById('filtroEquipe').value = 'todos';
        document.getElementById('filtroMarca').value = 'todos';
        document.getElementById('filtroFamilia').value = 'todos';
        document.getElementById('filtroDataInicio').value = '{{ min_date.strftime("%Y-%m-%d") if min_date else "" }}';
        document.getElementById('filtroDataFim').value = '{{ max_date.strftime("%Y-%m-%d") if max_date else "" }}';
        carregarTodasMetricas();
    });
    
    document.getElementById('btnExportarExcel').addEventListener('click', exportarExcel);
    document.getElementById('btnRecarregarDados').addEventListener('click', carregarTodasMetricas);
});

// (Manter todas as outras fun√ß√µes originais)
</script>

<style>
/* Estilos Power BI */
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.bg-gradient-success {
    background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%) !important;
}

.bg-gradient-warning {
    background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%) !important;
}

.bg-gradient-dark {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
}

.kpi-card {
    border-radius: 10px;
    transition: all 0.3s ease;
    border: none;
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.kpi-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.2) !important;
}

.kpi-value {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.kpi-label {
    font-size: 0.85rem;
    font-weight: 500;
}

.kpi-icon {
    opacity: 0.8;
}

.hover-lift {
    transition: all 0.3s ease;
    border: 1px solid rgba(0,0,0,0.05);
}

.hover-lift:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.nav-tabs-custom .nav-link {
    border: none;
    font-weight: 500;
    color: #6c757d;
    padding: 0.75rem 1.25rem;
    border-radius: 8px 8px 0 0;
}

.nav-tabs-custom .nav-link.active {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
    border: none;
    font-weight: 600;
}

.table th {
    font-weight: 600;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #6c757d;
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    font-size: 0.85rem;
    vertical-align: middle;
    border-color: #f1f3f4;
}

.table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(0,0,0,0.02);
}

.table-hover tbody tr:hover {
    background-color: rgba(52, 152, 219, 0.1);
    cursor: pointer;
}

.form-control, .form-select {
    border-radius: 6px;
    border: 1px solid #e0e0e0;
    font-size: 0.9rem;
}

.form-control:focus, .form-select:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
}

.form-label {
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 0.3rem;
}

.card-header {
    border-radius: 10px 10px 0 0 !important;
}

.pagination .page-item.active .page-link {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    border-color: #2980b9;
    font-weight: 600;
}

.pagination .page-link {
    border-radius: 6px;
    margin: 0 2px;
    border: 1px solid #e0e0e0;
    color: #495057;
}

/* Anima√ß√µes */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate__fadeInUp {
    animation-name: fadeInUp;
    animation-duration: 0.5s;
    animation-fill-mode: both;
}

/* Responsividade */
@media (max-width: 768px) {
    .kpi-value {
        font-size: 1.4rem;
    }
    
    .kpi-card {
        min-height: 100px;
    }
    
    .table-responsive {
        font-size: 0.8rem;
    }
    
    .nav-tabs-custom .nav-link {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
    }
}
</style>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<!-- Header do Dashboard de An√°lise -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-primary-custom text-white">
            <div class="card-body text-center py-4">
                <h1 class="display-5 mb-2">üìä An√°lise de Vendas - Evento 2025</h1>
                <p class="lead mb-0">Dashboard completo com m√©tricas de vendas, capilaridade e an√°lise por marca</p>
            </div>
        </div>
    </div>
</div>

<!-- Painel de Filtros -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm card-hover">
            <div class="card-header bg-success-custom text-white">
                <h6 class="mb-0">üîç Filtros de An√°lise</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label text-white"><strong>Cliente</strong></label>
                        <select class="form-select" id="filtroCliente">
                            <option value="todos">Todos os Clientes</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente }}">{{ cliente }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label text-white"><strong>Vendedor</strong></label>
                        <select class="form-select" id="filtroVendedor">
                            <option value="todos">Todos os Vendedores</option>
                            {% for vendedor in vendedores %}
                            <option value="{{ vendedor }}">{{ vendedor }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label text-white"><strong>Marca</strong></label>
                        <select class="form-select" id="filtroMarca">
                            <option value="todos">Todas as Marcas</option>
                            {% for marca in marcas %}
                            <option value="{{ marca }}">{{ marca }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label text-white"><strong>Equipe</strong></label>
                        <select class="form-select" id="filtroEquipe">
                            <option value="todos">Todas as Equipes</option>
                            {% for equipe in equipes %}
                            <option value="{{ equipe }}">{{ equipe }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label text-white"><strong>Fam√≠lia</strong></label>
                        <select class="form-select" id="filtroFamilia">
                            <option value="todos">Todas as Fam√≠lias</option>
                            {% for familia in familias %}
                            <option value="{{ familia }}">{{ familia }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label text-white"><strong>Data In√≠cio</strong></label>
                        <input type="date" class="form-control" id="filtroDataInicio" value="{{ min_date }}">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label text-white"><strong>Data Fim</strong></label>
                        <input type="date" class="form-control" id="filtroDataFim" value="{{ max_date }}">
                    </div>
                    <div class="col-lg-3 col-md-6 d-flex align-items-end">
                        <button class="btn btn-primary-custom w-100" onclick="aplicarFiltros()">
                            üîÑ Aplicar Filtros
                        </button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-success-custom" onclick="exportarParaExcel()">
                                üì• Exportar Excel
                            </button>
                            <button class="btn btn-warning text-white" onclick="exportarParaImagem()" id="btnExportarImagem">
                                üì∏ Exportar Imagem do Relat√≥rio
                            </button>
                            <button class="btn btn-secondary" onclick="resetarFiltros()">
                                üóëÔ∏è Limpar Filtros
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- M√©tricas Consolidadas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm stat-card card-hover">
            <div class="card-header bg-success-custom text-white">
                <h6 class="mb-0">üìà M√©tricas Consolidadas</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <!-- Total de Vendas (Valor) -->
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="card bg-light border-0 h-100 card-hover">
                            <div class="card-body py-3">
                                <h4 class="text-primary mb-1" id="totalValorVendas">R$ 0</h4>
                                <small class="text-muted">Total Vendas (Valor)</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total de NFs -->
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="card bg-light border-0 h-100 card-hover">
                            <div class="card-body py-3">
                                <h4 class="text-success mb-1" id="totalNFs">0</h4>
                                <small class="text-muted">Total de NFs</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total de Itens -->
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="card bg-light border-0 h-100 card-hover">
                            <div class="card-body py-3">
                                <h4 class="text-info mb-1" id="totalItens">0</h4>
                                <small class="text-muted">Total de Itens</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ticket M√©dio -->
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="card bg-light border-0 h-100 card-hover">
                            <div class="card-body py-3">
                                <h4 class="text-warning mb-1" id="ticketMedio">R$ 0</h4>
                                <small class="text-muted">Ticket M√©dio</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Consultor Top -->
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="card bg-light border-0 h-100 card-hover">
                            <div class="card-body py-3">
                                <h5 class="text-purple mb-1" id="topConsultor">N/A</h5>
                                <small class="text-muted">Consultor Top</small>
                                <div class="mt-1">
                                    <small class="text-success" id="topConsultorValor">R$ 0</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Revenda Top -->
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="card bg-light border-0 h-100 card-hover">
                            <div class="card-body py-3">
                                <h5 class="text-danger mb-1" id="topRevenda">N/A</h5>
                                <small class="text-muted">Revenda Top</small>
                                <div class="mt-1">
                                    <small class="text-success" id="topRevendaValor">R$ 0</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Distribui√ß√£o por Marca COM PORCENTAGENS -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-primary text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">üí∞ Distribui√ß√£o por Marca (Valor)</h6>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="togglePorcentagem" checked>
                                        <label class="form-check-label text-white" for="togglePorcentagem">
                                            Mostrar %
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-lg-8">
                                        <canvas id="chartMarcas" height="300"></canvas>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Marca</th>
                                                        <th class="text-end">Valor</th>
                                                        <th class="text-end">%</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tabelaPorcentagemMarca">
                                                    <tr>
                                                        <td colspan="3" class="text-center text-muted">Carregando dados...</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Capilaridade Geral (mantida) -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm card-hover">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">üåê Capilaridade Geral</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="card bg-light border-0">
                            <div class="card-body py-3">
                                <h5 class="text-info mb-1" id="capClientes">0</h5>
                                <small class="text-muted">Clientes</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card bg-light border-0">
                            <div class="card-body py-3">
                                <h5 class="text-success mb-1" id="capVendedores">0</h5>
                                <small class="text-muted">Vendedores</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card bg-light border-0">
                            <div class="card-body py-3">
                                <h5 class="text-warning mb-1" id="capMarcas">0</h5>
                                <small class="text-muted">Marcas</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row text-center mt-3">
                    <div class="col-6">
                        <div class="card bg-light border-0">
                            <div class="card-body py-3">
                                <h5 class="text-secondary mb-1" id="capMediaItensNF">0.0</h5>
                                <small class="text-muted">M√©dia Itens/NF</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-light border-0">
                            <div class="card-body py-3">
                                <h5 class="text-secondary mb-1" id="capMediaValorNF">R$ 0</h5>
                                <small class="text-muted">M√©dia Valor/NF</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NOVA: An√°lise Detalhada por Marca -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm card-hover">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">üìä An√°lise Detalhada por Marca</h6>
                    <div class="col-md-4">
                        <select class="form-select" id="selecionarMarca" onchange="carregarAnaliseMarca(this.value)">
                            <option value="">Selecione uma marca</option>
                            {% for marca in marcas %}
                            <option value="{{ marca }}">{{ marca }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- M√©tricas da Marca Selecionada -->
                <div class="row mb-4" id="metricasMarca">
                    <div class="col-12 text-center py-5">
                        <div class="display-1 text-muted mb-3">üè∑Ô∏è</div>
                        <h4 class="text-muted">Selecione uma marca para ver a an√°lise detalhada</h4>
                        <p class="text-muted mt-2">Clique no dropdown acima para escolher uma marca</p>
                    </div>
                </div>
                
                <!-- Conte√∫do da An√°lise da Marca (aparece quando selecionada) -->
                <div id="conteudoAnaliseMarca" style="display: none;">
                    <!-- M√©tricas Principais da Marca -->
                    <div class="row mb-4">
                        <div class="col-xl-3 col-lg-6 mb-3">
                            <div class="card bg-light border-0 h-100 card-hover">
                                <div class="card-body text-center py-4">
                                    <div class="display-4 text-primary mb-2" id="marcaTotalFaturamento">R$ 0</div>
                                    <h6 class="text-muted">Total Faturamento</h6>
                                    <small class="text-muted" id="marcaPercentualTotal">0% do total</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-xl-3 col-lg-6 mb-3">
                            <div class="card bg-light border-0 h-100 card-hover">
                                <div class="card-body text-center py-4">
                                    <div class="display-4 text-success mb-2" id="marcaTicketMedio">R$ 0</div>
                                    <h6 class="text-muted">Ticket M√©dio por Cliente</h6>
                                    <small class="text-muted">Valor m√©dio por comprador</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-xl-3 col-lg-6 mb-3">
                            <div class="card bg-light border-0 h-100 card-hover">
                                <div class="card-body text-center py-4">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="display-4 text-info mb-2" id="marcaTotalClientes">0</div>
                                            <small class="text-muted">Clientes Totais</small>
                                        </div>
                                        <div class="col-6">
                                            <div class="display-4 text-warning mb-2" id="marcaCompradores">0</div>
                                            <small class="text-muted">Compradores</small>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <h6 class="text-muted">Penetra√ß√£o</h6>
                                        <div class="progress" style="height: 10px;">
                                            <div id="marcaPenetracaoBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="marcaPenetracaoPercent">0%</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-xl-3 col-lg-6 mb-3">
                            <div class="card bg-light border-0 h-100 card-hover">
                                <div class="card-body text-center py-4">
                                    <div class="display-4 text-purple mb-2" id="marcaVendasCros">R$ 0</div>
                                    <h6 class="text-muted">Vendas CROS</h6>
                                    <small class="text-muted" id="marcaPercentualCros">0% do faturamento</small>
                                    <div class="mt-2">
                                        <small class="text-muted" id="marcaNfsCros">0 NFs mistas</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gr√°ficos da Marca -->
                    <div class="row mb-4">
                        <!-- Gr√°fico: Clientes vs Compradores -->
                        <div class="col-lg-6 mb-4">
                            <div class="card h-100 card-hover">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">üë• Clientes vs Compradores</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="chartClientesCompradores" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico: Top 10 Produtos por Valor -->
                        <div class="col-lg-6 mb-4">
                            <div class="card h-100 card-hover">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">üèÜ Top 10 Produtos (por Valor)</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="chartTopProdutos" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabela Detalhada de Top Produtos -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-hover">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">üìã Detalhamento Top Produtos</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>#</th>
                                                    <th>Produto</th>
                                                    <th class="text-end">Quantidade</th>
                                                    <th class="text-end">Valor Unit√°rio</th>
                                                    <th class="text-end">Valor Total</th>
                                                    <th class="text-end">% da Marca</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tabelaTopProdutosDetalhado">
                                                <tr>
                                                    <td colspan="6" class="text-center text-muted">Selecione uma marca para ver os produtos</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabela Detalhada de Vendas (mantida) -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm card-hover">
            <div class="card-header bg-dark text-white">
                <h6 class="mb-0">üìã Vendas Detalhadas</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="tabelaVendas">
                        <thead class="table-dark">
                            <tr>
                                <th>NF</th>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Vendedor</th>
                                <th>Equipe</th>
                                <th>Produto</th>
                                <th>Marca</th>
                                <th>Fam√≠lia</th>
                                <th>Qtd</th>
                                <th>Valor Unit.</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaVendas">
                            <tr>
                                <td colspan="11" class="text-center">Carregando dados...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Pagina√ß√£o -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <span class="me-2 text-muted">Itens por p√°gina:</span>
                            <select class="form-select form-select-sm w-auto" id="itensPorPagina" onchange="carregarVendasFiltradas()">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <nav aria-label="Pagina√ß√£o">
                            <ul class="pagination justify-content-end" id="paginacao">
                                <!-- Pagina√ß√£o ser√° gerada via JS -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bot√£o Voltar -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <a href="{{ url_for('index') }}" class="btn btn-primary-custom btn-lg">
            üè† Voltar para P√°gina Inicial
        </a>
    </div>
</div>

<!-- CSS local -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/sweetalert2.min.css') }}">

<!-- COM CDN (para teste r√°pido) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Vari√°veis globais
let vendasFiltradas = [];
let paginaAtual = 1;
let itensPorPagina = 50;
let graficoMarcas = null;
let graficoClientesCompradores = null;
let graficoTopProdutos = null;
let graficoDistribuicaoFamilia = null;

// Inicializar dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log("üîß Inicializando dashboard de an√°lise...");
    carregarDadosIniciais();
    
    // Evento para toggle de porcentagem
    document.getElementById('togglePorcentagem').addEventListener('change', function() {
        if (graficoMarcas) {
            atualizarGraficoMarcasComPorcentagem();
        }
    });
});

// Carregar dados iniciais
function carregarDadosIniciais() {
    // Carregar m√©tricas usando a rota existente
    fetch('/api/metricas-vendas')
    .then(response => response.json())
    .then(data => {
        console.log("üìà M√©tricas iniciais:", data);
        atualizarMetricasIniciais(data);
    })
    .catch(error => {
        console.error("‚ùå Erro ao carregar m√©tricas:", error);
    });
    
    // Carregar capilaridade
    carregarCapilaridade();
    
    // Carregar vendas iniciais
    carregarVendasFiltradas();
}

// Atualizar m√©tricas iniciais
function atualizarMetricasIniciais(data) {
    // Total de vendas
    if (data.totais_por_nf) {
        document.getElementById('totalValorVendas').textContent = 
            'R$ ' + formatarNumero(data.totais_por_nf.total_valor || 0);
        document.getElementById('totalNFs').textContent = data.totais_por_nf.total_nfs || 0;
        document.getElementById('totalItens').textContent = data.totais_por_nf.total_itens || 0;
        document.getElementById('ticketMedio').textContent = 
            'R$ ' + formatarNumero(data.totais_por_nf.media_valor_por_nf || 0);
    }
    
    // Consultor top
    if (data.vendedores?.maior_valor) {
        document.getElementById('topConsultor').textContent = 
            data.vendedores.maior_valor.nome?.substring(0, 20) || 'N/A';
        document.getElementById('topConsultorValor').textContent = 
            'R$ ' + formatarNumero(data.vendedores.maior_valor.valor || 0);
    }
    
    // Revenda top
    if (data.clientes?.maior_valor) {
        document.getElementById('topRevenda').textContent = 
            data.clientes.maior_valor.nome?.substring(0, 20) || 'N/A';
        document.getElementById('topRevendaValor').textContent = 
            'R$ ' + formatarNumero(data.clientes.maior_valor.valor || 0);
    }
    
    // Criar gr√°fico de marcas COM PORCENTAGENS
    if (data.marcas_por_nf && data.marcas_por_nf.length > 0) {
        criarGraficoMarcasComPorcentagem(data.marcas_por_nf, data.totais_por_nf?.total_valor || 0);
    }
}

// Fun√ß√£o para aplicar filtros
function aplicarFiltros() {
    console.log("üîç Aplicando filtros...");
    paginaAtual = 1;
    carregarMetricasComFiltros();
    carregarCapilaridadeComFiltros();
    carregarVendasFiltradas();
    
    // Resetar an√°lise de marca
    document.getElementById('selecionarMarca').value = '';
    document.getElementById('conteudoAnaliseMarca').style.display = 'none';
    document.getElementById('metricasMarca').innerHTML = `
        <div class="col-12 text-center py-5">
            <div class="display-1 text-muted mb-3">üè∑Ô∏è</div>
            <h4 class="text-muted">Selecione uma marca para ver a an√°lise detalhada</h4>
            <p class="text-muted mt-2">Clique no dropdown acima para escolher uma marca</p>
        </div>
    `;
}

// Carregar m√©tricas com filtros
function carregarMetricasComFiltros() {
    const filtros = obterFiltros();
    console.log("üìä Carregando m√©tricas com filtros:", filtros);
    
    // 1. Primeiro pega os totais b√°sicos da rota /api/vendas-filtradas
    fetch('/api/vendas-filtradas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            ...filtros,
            page: 1,
            per_page: 1
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log("üìà Dados b√°sicos filtrados:", data);
        
        // Atualizar m√©tricas b√°sicas
        document.getElementById('totalValorVendas').textContent = 
            'R$ ' + formatarNumero(data.total_valor || 0);
        document.getElementById('totalNFs').textContent = data.total_vendas || 0;
        document.getElementById('totalItens').textContent = data.total_quantidade || 0;
        
        // Calcular ticket m√©dio
        const ticketMedio = data.total_valor / (data.total_vendas || 1);
        document.getElementById('ticketMedio').textContent = 
            'R$ ' + formatarNumero(ticketMedio);
        
        // 2. Agora busca os tops e distribui√ß√£o por marca
        return fetch('/api/metricas-vendas-filtradas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filtros)
        });
    })
    .then(response => response.json())
    .then(data => {
        console.log("üèÜ Dados tops filtrados:", data);
        
        // Top consultor
        if (data.vendedores?.maior_valor?.nome) {
            document.getElementById('topConsultor').textContent = 
                data.vendedores.maior_valor.nome.length > 20 ? 
                data.vendedores.maior_valor.nome.substring(0, 20) + '...' : 
                data.vendedores.maior_valor.nome;
            document.getElementById('topConsultorValor').textContent = 
                'R$ ' + formatarNumero(data.vendedores.maior_valor.valor || 0);
        } else {
            document.getElementById('topConsultor').textContent = 'N/A';
            document.getElementById('topConsultorValor').textContent = 'R$ 0';
        }
        
        // Top revenda
        if (data.clientes?.maior_valor?.nome) {
            document.getElementById('topRevenda').textContent = 
                data.clientes.maior_valor.nome.length > 20 ? 
                data.clientes.maior_valor.nome.substring(0, 20) + '...' : 
                data.clientes.maior_valor.nome;
            document.getElementById('topRevendaValor').textContent = 
                'R$ ' + formatarNumero(data.clientes.maior_valor.valor || 0);
        } else {
            document.getElementById('topRevenda').textContent = 'N/A';
            document.getElementById('topRevendaValor').textContent = 'R$ 0';
        }
        
        // Atualizar gr√°fico de marcas COM PORCENTAGENS
        const totalVendas = parseFloat(document.getElementById('totalValorVendas').textContent.replace('R$ ', '').replace('.', '').replace(',', '.'));
        if (data.marcas_por_nf && data.marcas_por_nf.length > 0) {
            criarGraficoMarcasComPorcentagem(data.marcas_por_nf, totalVendas || 0);
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao carregar m√©tricas com filtros:', error);
    });
}

// Carregar capilaridade com filtros
function carregarCapilaridadeComFiltros() {
    const filtros = obterFiltros();
    
    fetch('/api/capilaridade-vendas-filtradas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(filtros)
    })
    .then(response => response.json())
    .then(data => {
        console.log("üåê Dados de capilaridade com filtros:", data);
        
        // Atualizar m√©tricas de capilaridade
        if (data.estatisticas_gerais) {
            document.getElementById('capClientes').textContent = data.estatisticas_gerais.total_clientes || 0;
            document.getElementById('capVendedores').textContent = data.estatisticas_gerais.total_vendedores || 0;
            document.getElementById('capMarcas').textContent = data.estatisticas_gerais.total_marcas || 0;
            document.getElementById('capMediaItensNF').textContent = 
                (data.estatisticas_gerais.media_itens_por_nf || 0).toFixed(1);
            document.getElementById('capMediaValorNF').textContent = 
                'R$ ' + formatarNumero(data.estatisticas_gerais.media_valor_por_nf || 0);
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao carregar capilaridade com filtros:', error);
    });
}

// Carregar vendas filtradas
function carregarVendasFiltradas() {
    const filtros = obterFiltros();
    filtros.page = paginaAtual;
    filtros.per_page = parseInt(document.getElementById('itensPorPagina').value);
    
    console.log("üìã Carregando vendas com filtros:", filtros);
    
    fetch('/api/vendas-filtradas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(filtros)
    })
    .then(response => response.json())
    .then(data => {
        console.log("‚úÖ Vendas carregadas:", data.vendas?.length || 0, "itens");
        vendasFiltradas = data.vendas || [];
        
        // Atualizar tabela
        atualizarTabelaVendas(vendasFiltradas);
        
        // Atualizar pagina√ß√£o
        atualizarPaginacao(data.total_vendas || 0, data.page || 1, data.pages || 1);
    })
    .catch(error => {
        console.error('‚ùå Erro ao carregar vendas filtradas:', error);
        document.getElementById('corpoTabelaVendas').innerHTML = `
            <tr>
                <td colspan="11" class="text-center text-danger">
                    Erro ao carregar dados
                </td>
            </tr>
        `;
    });
}

// Carregar an√°lise de marca espec√≠fica
function carregarAnaliseMarca(marca) {
    if (!marca) {
        document.getElementById('conteudoAnaliseMarca').style.display = 'none';
        document.getElementById('metricasMarca').innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="display-1 text-muted mb-3">üè∑Ô∏è</div>
                <h4 class="text-muted">Selecione uma marca para ver a an√°lise detalhada</h4>
                <p class="text-muted mt-2">Clique no dropdown acima para escolher uma marca</p>
            </div>
        `;
        return;
    }
    
    console.log(`üìä Carregando an√°lise da marca: ${marca}`);
    
    // Obter filtros atuais
    const filtros = obterFiltros();
    filtros.marca_especifica = marca;
    
    // Usar nova rota para an√°lise detalhada da marca
    fetch('/api/analise-detalhada-marca', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(filtros)
    })
    .then(response => response.json())
    .then(data => {
        console.log(`‚úÖ Dados detalhados da marca ${marca}:`, data);
        
        // Mostrar conte√∫do
        document.getElementById('conteudoAnaliseMarca').style.display = 'block';
        document.getElementById('metricasMarca').innerHTML = `
            <div class="col-12 mb-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center py-3">
                        <h3 class="mb-0">${marca}</h3>
                        <p class="mb-0">An√°lise detalhada com filtros aplicados</p>
                    </div>
                </div>
            </div>
        `;
        
        // Atualizar m√©tricas da marca
        if (data.dados_gerais) {
            atualizarMetricasMarca(data.dados_gerais, data);
        }
        
        // Criar gr√°ficos
        if (data.clientes_compradores) {
            criarGraficoClientesCompradores(data.clientes_compradores);
        }
        
        if (data.top_produtos && data.top_produtos.length > 0) {
            criarGraficoTopProdutos(data.top_produtos);
            atualizarTabelaTopProdutosDetalhado(data.top_produtos, data.dados_gerais?.total_valor || 0);
        }
        
    })
    .catch(error => {
        console.error(`‚ùå Erro ao carregar an√°lise da marca ${marca}:`, error);
        document.getElementById('metricasMarca').innerHTML = `
            <div class="col-12 text-center py-4">
                <p class="text-danger">Erro ao carregar dados da marca</p>
                <p class="text-muted">${error.message}</p>
            </div>
        `;
    });
}

// Atualizar m√©tricas da marca
function atualizarMetricasMarca(dados, dataCompleta) {
    // Total faturamento
    const totalFaturamento = dados.total_valor || 0;
    const totalGeral = parseFloat(document.getElementById('totalValorVendas').textContent.replace('R$ ', '').replace('.', '').replace(',', '.'));
    const percentualTotal = totalGeral > 0 ? (totalFaturamento / totalGeral * 100).toFixed(1) : 0;
    
    document.getElementById('marcaTotalFaturamento').textContent = 'R$ ' + formatarNumero(totalFaturamento);
    document.getElementById('marcaPercentualTotal').textContent = percentualTotal + '% do total';
    
    // Ticket m√©dio
    const ticketMedio = dados.ticket_medio_cliente || 0;
    document.getElementById('marcaTicketMedio').textContent = 'R$ ' + formatarNumero(ticketMedio);
    
    // Clientes vs Compradores
    const totalClientes = dataCompleta.estatisticas_clientes?.total_clientes || 0;
    const compradoresMarca = dados.clientes_compradores || 0;
    const penetracao = totalClientes > 0 ? (compradoresMarca / totalClientes * 100).toFixed(1) : 0;
    
    document.getElementById('marcaTotalClientes').textContent = totalClientes;
    document.getElementById('marcaCompradores').textContent = compradoresMarca;
    document.getElementById('marcaPenetracaoBar').style.width = penetracao + '%';
    document.getElementById('marcaPenetracaoPercent').textContent = penetracao + '%';
    
    // Vendas CROS
    const vendasCros = dados.vendas_cros?.valor_total || 0;
    const nfsCros = dados.vendas_cros?.total_nfs || 0;
    const percentualCros = totalFaturamento > 0 ? (vendasCros / totalFaturamento * 100).toFixed(1) : 0;
    
    document.getElementById('marcaVendasCros').textContent = 'R$ ' + formatarNumero(vendasCros);
    document.getElementById('marcaPercentualCros').textContent = percentualCros + '% do faturamento';
    document.getElementById('marcaNfsCros').textContent = nfsCros + ' NFs mistas';
}

// Criar gr√°fico de marcas COM PORCENTAGENS
function criarGraficoMarcasComPorcentagem(dadosMarcas, totalVendas) {
    const ctx = document.getElementById('chartMarcas');
    if (!ctx) {
        console.error("‚ùå Elemento chartMarcas n√£o encontrado!");
        return;
    }
    
    // Destruir gr√°fico anterior se existir
    if (graficoMarcas) {
        graficoMarcas.destroy();
    }
    
    // Ordenar por valor (decrescente)
    dadosMarcas.sort((a, b) => (b.valor || 0) - (a.valor || 0));
    
    // Preparar dados
    const labels = dadosMarcas.map(marca => marca.marca || 'Desconhecida');
    const valores = dadosMarcas.map(marca => marca.valor || 0);
    const porcentagens = totalVendas > 0 ? 
        valores.map(valor => ((valor / totalVendas) * 100).toFixed(1)) : 
        valores.map(() => '0.0');
    
    // Atualizar tabela de porcentagens
    atualizarTabelaPorcentagemMarca(dadosMarcas, totalVendas);
    
    // Cores do dashboard original
    const cores = [
        '#28a745', '#20c997', '#17a2b8', '#007bff', '#6f42c1',
        '#e83e8c', '#fd7e14', '#ffc107', '#dc3545', '#343a40'
    ];
    
    // Configurar tooltip com ou sem porcentagem
    const showPercentage = document.getElementById('togglePorcentagem').checked;
    
    graficoMarcas = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.slice(0, 10), // Mostrar apenas top 10
            datasets: [{
                label: 'Valor (R$)',
                data: valores.slice(0, 10),
                backgroundColor: cores.slice(0, Math.min(valores.length, 10)),
                borderColor: cores.slice(0, Math.min(valores.length, 10)),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const valor = context.raw;
                            const porcentagem = showPercentage ? 
                                ` (${((valor / totalVendas) * 100).toFixed(1)}%)` : '';
                            return `R$ ${formatarNumero(valor)}${porcentagem}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + formatarNumero(value);
                        }
                    }
                }
            }
        }
    });
}

// Atualizar tabela de porcentagem de marcas
function atualizarTabelaPorcentagemMarca(dadosMarcas, totalVendas) {
    const tbody = document.getElementById('tabelaPorcentagemMarca');
    let html = '';
    
    // Ordenar por valor (decrescente)
    dadosMarcas.sort((a, b) => (b.valor || 0) - (a.valor || 0));
    
    dadosMarcas.slice(0, 10).forEach((marca, index) => {
        const valor = marca.valor || 0;
        const porcentagem = totalVendas > 0 ? ((valor / totalVendas) * 100).toFixed(1) : '0.0';
        
        html += `
            <tr>
                <td>
                    <span class="badge" style="background-color: #28a745; color: white; padding: 3px 8px; margin-right: 8px;">
                        ${index + 1}
                    </span>
                    ${marca.marca || 'Desconhecida'}
                </td>
                <td class="text-end">
                    <strong class="text-success">R$ ${formatarNumero(valor)}</strong>
                </td>
                <td class="text-end">
                    <span class="badge bg-info">${porcentagem}%</span>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Atualizar gr√°fico de marcas com toggle de porcentagem
function atualizarGraficoMarcasComPorcentagem() {
    if (graficoMarcas) {
        graficoMarcas.destroy();
        // Recriar o gr√°fico com as configura√ß√µes atuais
        // (Na pr√°tica, voc√™ precisaria recarregar os dados ou armazen√°-los)
        carregarMetricasComFiltros();
    }
}

// Criar gr√°fico de clientes vs compradores
function criarGraficoClientesCompradores(dados) {
    const ctx = document.getElementById('chartClientesCompradores');
    if (!ctx) return;
    
    // Destruir gr√°fico anterior se existir
    if (graficoClientesCompradores) {
        graficoClientesCompradores.destroy();
    }
    
    const totalClientes = dados.total_clientes || 0;
    const compradores = dados.compradores_marca || 0;
    const naoCompradores = totalClientes - compradores;
    
    graficoClientesCompradores = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Comparativo'],
            datasets: [
                {
                    label: 'Total de Clientes',
                    data: [totalClientes],
                    backgroundColor: '#17a2b8',
                    borderColor: '#117a8b',
                    borderWidth: 1
                },
                {
                    label: 'Compradores da Marca',
                    data: [compradores],
                    backgroundColor: '#28a745',
                    borderColor: '#1e7e34',
                    borderWidth: 1
                },
                {
                    label: 'N√£o Compradores',
                    data: [naoCompradores],
                    backgroundColor: '#6c757d',
                    borderColor: '#545b62',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Quantidade de Clientes'
                    }
                }
            }
        }
    });
}

// Criar gr√°fico de top 10 produtos por valor
function criarGraficoTopProdutos(produtos) {
    const ctx = document.getElementById('chartTopProdutos');
    if (!ctx) return;
    
    // Destruir gr√°fico anterior se existir
    if (graficoTopProdutos) {
        graficoTopProdutos.destroy();
    }
    
    // Ordenar por valor (decrescente) e pegar top 10
    produtos.sort((a, b) => (b.valor_total || 0) - (a.valor_total || 0));
    const top10 = produtos.slice(0, 10);
    
    // Preparar dados
    const labels = top10.map(prod => {
        const nome = prod.produto || 'Desconhecido';
        return nome.length > 20 ? nome.substring(0, 20) + '...' : nome;
    });
    const valores = top10.map(prod => prod.valor_total || 0);
    const quantidades = top10.map(prod => prod.quantidade || 0);
    
    // Cores
    const cores = [
        '#28a745', '#20c997', '#17a2b8', '#007bff', '#6f42c1',
        '#e83e8c', '#fd7e14', '#ffc107', '#dc3545', '#343a40'
    ];
    
    graficoTopProdutos = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Valor Total (R$)',
                data: valores,
                backgroundColor: cores.slice(0, valores.length),
                borderColor: cores.slice(0, valores.length),
                borderWidth: 1,
                yAxisID: 'y'
            }, {
                label: 'Quantidade',
                data: quantidades,
                type: 'line',
                borderColor: '#ffc107',
                backgroundColor: 'transparent',
                borderWidth: 2,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (context.datasetIndex === 0) {
                                return `Valor: R$ ${formatarNumero(context.raw)}`;
                            } else {
                                return `Quantidade: ${context.raw}`;
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Valor (R$)'
                    },
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + formatarNumero(value);
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Quantidade'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

// Atualizar tabela detalhada de top produtos
function atualizarTabelaTopProdutosDetalhado(produtos, totalMarca) {
    const tbody = document.getElementById('tabelaTopProdutosDetalhado');
    let html = '';
    
    // Ordenar por valor (decrescente)
    produtos.sort((a, b) => (b.valor_total || 0) - (a.valor_total || 0));
    
    produtos.slice(0, 15).forEach((prod, index) => {
        const valorTotal = prod.valor_total || 0;
        const percentualMarca = totalMarca > 0 ? ((valorTotal / totalMarca) * 100).toFixed(1) : '0.0';
        const valorUnitario = prod.quantidade > 0 ? (valorTotal / prod.quantidade) : 0;
        
        html += `
            <tr>
                <td>${index + 1}</td>
                <td>${prod.produto || 'Desconhecido'}</td>
                <td class="text-end">${prod.quantidade || 0}</td>
                <td class="text-end">R$ ${formatarNumero(valorUnitario)}</td>
                <td class="text-end">
                    <strong class="text-success">R$ ${formatarNumero(valorTotal)}</strong>
                </td>
                <td class="text-end">
                    <span class="badge bg-info">${percentualMarca}%</span>
                </td>
            </tr>
        `;
    });
    
    if (html === '') {
        html = `
            <tr>
                <td colspan="6" class="text-center text-muted">
                    Nenhum produto encontrado para esta marca
                </td>
            </tr>
        `;
    }
    
    tbody.innerHTML = html;
}

// Fun√ß√µes auxiliares (mantidas do original)
function formatarNumero(valor) {
    return parseFloat(valor || 0).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function obterFiltros() {
    return {
        cliente: document.getElementById('filtroCliente').value,
        vendedor: document.getElementById('filtroVendedor').value,
        marca: document.getElementById('filtroMarca').value,
        equipe: document.getElementById('filtroEquipe').value,
        familia: document.getElementById('filtroFamilia').value,
        data_inicio: document.getElementById('filtroDataInicio').value,
        data_fim: document.getElementById('filtroDataFim').value,
        sort_by: 'data_emissao',
        sort_order: 'desc'
    };
}

function resetarFiltros() {
    document.getElementById('filtroCliente').value = 'todos';
    document.getElementById('filtroVendedor').value = 'todos';
    document.getElementById('filtroMarca').value = 'todos';
    document.getElementById('filtroEquipe').value = 'todos';
    document.getElementById('filtroFamilia').value = 'todos';
    document.getElementById('filtroDataInicio').value = '{{ min_date }}';
    document.getElementById('filtroDataFim').value = '{{ max_date }}';
    paginaAtual = 1;
    aplicarFiltros();
}

function atualizarTabelaVendas(dados) {
    const tbody = document.getElementById('corpoTabelaVendas');
    let html = '';
    
    if (dados.length === 0) {
        html = `
            <tr>
                <td colspan="11" class="text-center text-muted">
                    Nenhuma venda encontrada
                </td>
            </tr>
        `;
    } else {
        dados.forEach(venda => {
            html += `
                <tr>
                    <td><code>${venda.numero_nf || 'N/A'}</code></td>
                    <td>${venda.data_emissao || ''}</td>
                    <td>${venda.cliente_nome || ''}</td>
                    <td>${venda.vendedor || ''}</td>
                    <td><span class="badge bg-secondary">${venda.equipe || ''}</span></td>
                    <td>${venda.descricao_produto || ''}</td>
                    <td><span class="badge" style="background-color: #28a745;">${venda.marca || ''}</span></td>
                    <td>${venda.familia || 'N/A'}</td>
                    <td>${venda.quantidade || 0}</td>
                    <td>R$ ${formatarNumero(venda.valor_unitario || 0)}</td>
                    <td><strong class="text-success">R$ ${formatarNumero(venda.valor_total || 0)}</strong></td>
                </tr>
            `;
        });
    }
    
    tbody.innerHTML = html;
}

function atualizarPaginacao(total, pagina, totalPaginas) {
    const paginacao = document.getElementById('paginacao');
    let html = '';
    
    if (totalPaginas <= 1) {
        paginacao.innerHTML = '';
        return;
    }
    
    // Bot√£o anterior
    html += `
        <li class="page-item ${pagina === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="mudarPagina(${pagina - 1}); return false;">
                &laquo;
            </a>
        </li>
    `;
    
    // P√°ginas
    const inicio = Math.max(1, pagina - 2);
    const fim = Math.min(totalPaginas, pagina + 2);
    
    for (let i = inicio; i <= fim; i++) {
        html += `
            <li class="page-item ${i === pagina ? 'active' : ''}">
                <a class="page-link" href="#" onclick="mudarPagina(${i}); return false;">${i}</a>
            </li>
        `;
    }
    
    // Bot√£o pr√≥ximo
    html += `
        <li class="page-item ${pagina === totalPaginas ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="mudarPagina(${pagina + 1}); return false;">
                &raquo;
            </a>
        </li>
    `;
    
    paginacao.innerHTML = html;
}

function mudarPagina(novaPagina) {
    paginaAtual = novaPagina;
    carregarVendasFiltradas();
}

function exportarParaExcel() {
    const filtros = obterFiltros();
    const params = new URLSearchParams();
    
    Object.keys(filtros).forEach(key => {
        if (filtros[key]) {
            params.append(key, filtros[key]);
        }
    });
    
    window.location.href = `/exportar-vendas-filtradas?${params.toString()}`;
}

// Fun√ß√£o para carregar capilaridade (mantida do original)
function carregarCapilaridade() {
    fetch('/api/capilaridade-vendas')
    .then(response => response.json())
    .then(data => {
        console.log("üåê Dados de capilaridade:", data);
        
        // Atualizar m√©tricas de capilaridade
        if (data.estatisticas_gerais) {
            document.getElementById('capClientes').textContent = data.estatisticas_gerais.total_clientes || 0;
            document.getElementById('capVendedores').textContent = data.estatisticas_gerais.total_vendedores || 0;
            document.getElementById('capMarcas').textContent = data.estatisticas_gerais.total_marcas || 0;
            document.getElementById('capMediaItensNF').textContent = 
                (data.estatisticas_gerais.media_itens_por_nf || 0).toFixed(1);
            document.getElementById('capMediaValorNF').textContent = 
                'R$ ' + formatarNumero(data.estatisticas_gerais.media_valor_por_nf || 0);
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao carregar capilaridade:', error);
    });
}

/// Exportar para Imagem com filtros aplicados e logo
function exportarParaImagem() {
    const filtros = obterFiltros();
    
    // Mostrar loading
    const loadingToast = Swal.fire({
        title: 'Gerando relat√≥rio...',
        text: 'Processando dados com filtros aplicados',
        allowOutsideClick: false,
        showConfirmButton: false,
        willOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Primeiro, obter os dados filtrados do backend
    fetch('/exportar-analise-imagem', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ filtros: filtros })
    })
    .then(response => response.json())
    .then(data => {
        console.log("üìä Dados recebidos para exporta√ß√£o:", data);
        
        if (!data.success || !data.dados) {
            loadingToast.close();
            Swal.fire('Erro', data.message || 'N√£o foi poss√≠vel gerar o relat√≥rio', 'error');
            return;
        }
        
        const dados = data.dados;
        
        // Criar um container para a imagem
        const container = document.createElement('div');
        container.style.cssText = `
            width: 1200px;
            padding: 20px;
            background: white;
            color: #333;
            font-family: Arial, sans-serif;
            position: absolute;
            left: -9999px;
            top: -9999px;
        `;
        
        // Header com logo
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #28a745;
            position: relative;
        `;
        
        // Adicionar logo
        const logoUrl = '/static/images/logoreis.png';
        
        header.innerHTML = `
            <div style="flex: 1;">
                <h1 style="color: #28a745; margin: 0; font-size: 28px;">üìä Relat√≥rio de An√°lise de Vendas</h1>
                <p style="color: #666; margin: 5px 0; font-size: 16px;">R.O Experience 2025</p>
                <p style="color: #888; font-size: 12px; margin: 0;">
                    Filtros aplicados ‚Ä¢ Gerado em: ${dados.filtros_aplicados.data_geracao}
                </p>
            </div>
            <div style="width: 200px; height: 60px; display: flex; align-items: center; justify-content: flex-end;">
                <img src="${logoUrl}" 
                     alt="Logo Reis" 
                     style="max-width: 100%; max-height: 100%; height: auto; object-fit: contain; display: block;"
                     onerror="this.style.display='none';"
                     id="logoRelatorio">
            </div>
        `;
        container.appendChild(header);
        
        // Se√ß√£o de filtros
        const filtrosSection = document.createElement('div');
        filtrosSection.style.cssText = `
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #20c997;
        `;
        
        let filtrosText = [];
        if (dados.filtros_aplicados.cliente !== 'todos') filtrosText.push(`Cliente: ${dados.filtros_aplicados.cliente}`);
        if (dados.filtros_aplicados.vendedor !== 'todos') filtrosText.push(`Vendedor: ${dados.filtros_aplicados.vendedor}`);
        if (dados.filtros_aplicados.marca !== 'todos') filtrosText.push(`Marca: ${dados.filtros_aplicados.marca}`);
        if (dados.filtros_aplicados.equipe !== 'todos') filtrosText.push(`Equipe: ${dados.filtros_aplicados.equipe}`);
        if (dados.filtros_aplicados.familia !== 'todos') filtrosText.push(`Fam√≠lia: ${dados.filtros_aplicados.familia}`);
        if (dados.filtros_aplicados.data_inicio) filtrosText.push(`Data in√≠cio: ${dados.filtros_aplicados.data_inicio}`);
        if (dados.filtros_aplicados.data_fim) filtrosText.push(`Data fim: ${dados.filtros_aplicados.data_fim}`);
        
        filtrosSection.innerHTML = `
            <h3 style="color: #20c997; margin: 0 0 10px 0; font-size: 16px;">üîç Filtros Aplicados</h3>
            <p style="margin: 0; color: #495057; font-size: 14px;">
                ${filtrosText.length > 0 ? filtrosText.join(' ‚Ä¢ ') : 'Todos os dados'}
            </p>
        `;
        container.appendChild(filtrosSection);
        
        // M√©tricas Consolidadas
        const metricasSection = document.createElement('div');
        metricasSection.style.cssText = `
            margin-bottom: 30px;
        `;
        
        metricasSection.innerHTML = `
            <h3 style="color: #28a745; border-bottom: 1px solid #dee2e6; padding-bottom: 8px; margin-bottom: 15px; font-size: 20px;">
                üìà M√©tricas Consolidadas
            </h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div style="background: #e9f7ef; padding: 15px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 24px; color: #28a745; font-weight: bold;">
                        R$ ${formatarNumero(dados.metricas_consolidadas.total_valor || 0)}
                    </div>
                    <div style="color: #666; font-size: 12px;">Total Vendas</div>
                </div>
                <div style="background: #e9f7ef; padding: 15px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 24px; color: #28a745; font-weight: bold;">
                        ${dados.metricas_consolidadas.total_nfs || 0}
                    </div>
                    <div style="color: #666; font-size: 12px;">Total de NFs</div>
                </div>
                <div style="background: #e9f7ef; padding: 15px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 24px; color: #28a745; font-weight: bold;">
                        R$ ${formatarNumero(dados.metricas_consolidadas.ticket_medio || 0)}
                    </div>
                    <div style="color: #666; font-size: 12px;">Ticket M√©dio</div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                <div style="background: #f0f8ff; padding: 12px; border-radius: 6px; border-left: 3px solid #007bff;">
                    <div style="font-weight: bold; color: #007bff; font-size: 14px;">üèÜ Consultor Top</div>
                    <div style="font-size: 18px; margin: 5px 0; font-weight: bold;">${dados.metricas_consolidadas.consultor_top?.nome || 'N/A'}</div>
                    <div style="color: #666; font-size: 14px;">R$ ${formatarNumero(dados.metricas_consolidadas.consultor_top?.valor || 0)}</div>
                </div>
                <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 3px solid #ffc107;">
                    <div style="font-weight: bold; color: #856404; font-size: 14px;">üè¢ Revenda Top</div>
                    <div style="font-size: 18px; margin: 5px 0; font-weight: bold;">${dados.metricas_consolidadas.cliente_top?.nome || 'N/A'}</div>
                    <div style="color: #666; font-size: 14px;">R$ ${formatarNumero(dados.metricas_consolidadas.cliente_top?.valor || 0)}</div>
                </div>
            </div>
        `;
        container.appendChild(metricasSection);
        
        // Distribui√ß√£o por Marca (atualizado para usar dados.distribuicao_marca)
        const marcasSection = document.createElement('div');
        marcasSection.style.cssText = `
            margin-bottom: 30px;
        `;
        
        let marcasTable = '';
        if (dados.distribuicao_marca && dados.distribuicao_marca.length > 0) {
            marcasTable = `
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Marca</th>
                            <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;">Valor (R$)</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6;">NFs</th>
                            <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;">% Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${dados.distribuicao_marca.map((marca, index) => {
                            const percentual = dados.metricas_consolidadas.total_valor > 0 
                                ? ((marca.valor / dados.metricas_consolidadas.total_valor) * 100).toFixed(1)
                                : '0.0';
                            return `
                                <tr style="${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                                    <td style="padding: 8px 10px; border-bottom: 1px solid #eee;">${marca.marca}</td>
                                    <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; color: #28a745;">
                                        R$ ${formatarNumero(marca.valor || 0)}
                                    </td>
                                    <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">${marca.nfs || 0}</td>
                                    <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: right;">${percentual}%</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        } else {
            marcasTable = '<p style="text-align: center; color: #6c757d; font-size: 14px;">Nenhuma marca encontrada</p>';
        }
        
        marcasSection.innerHTML = `
            <h3 style="color: #28a745; border-bottom: 1px solid #dee2e6; padding-bottom: 8px; margin-bottom: 15px; font-size: 20px;">
                üí∞ Distribui√ß√£o por Marca
            </h3>
            ${marcasTable}
        `;
        container.appendChild(marcasSection);
        
        // Capilaridade Geral
        const capilaridadeSection = document.createElement('div');
        capilaridadeSection.style.cssText = `
            margin-bottom: 30px;
        `;
        
        capilaridadeSection.innerHTML = `
            <h3 style="color: #17a2b8; border-bottom: 1px solid #dee2e6; padding-bottom: 8px; margin-bottom: 15px; font-size: 20px;">
                üåê Capilaridade Geral
            </h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                <div style="background: #e3f2fd; padding: 15px; border-radius: 6px;">
                    <div style="font-size: 28px; color: #17a2b8; font-weight: bold;">
                        ${dados.capilaridade_geral.total_clientes || 0}
                    </div>
                    <div style="color: #666; font-size: 12px;">Clientes √önicos</div>
                </div>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 6px;">
                    <div style="font-size: 28px; color: #17a2b8; font-weight: bold;">
                        ${dados.capilaridade_geral.total_vendedores || 0}
                    </div>
                    <div style="color: #666; font-size: 12px;">Vendedores</div>
                </div>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 6px;">
                    <div style="font-size: 28px; color: #17a2b8; font-weight: bold;">
                        ${dados.capilaridade_geral.total_marcas || 0}
                    </div>
                    <div style="color: #666; font-size: 12px;">Marcas</div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; text-align: center;">
                    <div style="font-weight: bold; color: #6c757d; font-size: 14px;">üì¶ M√©dia Itens/NF</div>
                    <div style="font-size: 20px; color: #495057; margin: 5px 0; font-weight: bold;">
                        ${dados.capilaridade_geral.media_itens_por_nf ? dados.capilaridade_geral.media_itens_por_nf.toFixed(1) : '0.0'}
                    </div>
                </div>
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; text-align: center;">
                    <div style="font-weight: bold; color: #6c757d; font-size: 14px;">üí∞ M√©dia Valor/NF</div>
                    <div style="font-size: 20px; color: #495057; margin: 5px 0; font-weight: bold;">
                        R$ ${formatarNumero(dados.capilaridade_geral.media_valor_por_nf || 0)}
                    </div>
                </div>
            </div>
        `;
        container.appendChild(capilaridadeSection);
        
        // An√°lise por Marca (se dispon√≠vel) - ATUALIZADO
        if (dados.analise_marca) {
            const analiseMarcaSection = document.createElement('div');
            analiseMarcaSection.style.cssText = `
                margin-bottom: 30px;
            `;
            
            let produtosTable = '';
            if (dados.analise_marca.top_produtos && dados.analise_marca.top_produtos.length > 0) {
                produtosTable = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6;">Produto</th>
                                <th style="padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6;">Valor (R$)</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">Quantidade</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dados.analise_marca.top_produtos.map((produto, index) => {
                                const descricao = produto.descricao || produto.produto || 'Desconhecido';
                                return `
                                    <tr style="${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                                        <td style="padding: 6px 8px; border-bottom: 1px solid #eee;">
                                            ${descricao.length > 40 ? descricao.substring(0, 40) + '...' : descricao}
                                        </td>
                                        <td style="padding: 6px 8px; border-bottom: 1px solid #eee; text-align: right; color: #28a745; font-weight: bold;">
                                            R$ ${formatarNumero(produto.valor || 0)}
                                        </td>
                                        <td style="padding: 6px 8px; border-bottom: 1px solid #eee; text-align: center;">
                                            ${produto.quantidade || 0}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                produtosTable = '<p style="text-align: center; color: #6c757d; font-size: 12px;">Nenhum produto encontrado</p>';
            }
            
            let clientesTable = '';
            if (dados.analise_marca.top_clientes && dados.analise_marca.top_clientes.length > 0) {
                clientesTable = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6;">Cliente</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">NFs</th>
                                <th style="padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6;">Valor (R$)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dados.analise_marca.top_clientes.map((cliente, index) => {
                                const clienteNome = cliente.cliente || 'Desconhecido';
                                return `
                                    <tr style="${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                                        <td style="padding: 6px 8px; border-bottom: 1px solid #eee;">
                                            ${clienteNome.length > 30 ? clienteNome.substring(0, 30) + '...' : clienteNome}
                                        </td>
                                        <td style="padding: 6px 8px; border-bottom: 1px solid #eee; text-align: center;">
                                            ${cliente.nfs || 0}
                                        </td>
                                        <td style="padding: 6px 8px; border-bottom: 1px solid #eee; text-align: right; color: #28a745; font-weight: bold;">
                                            R$ ${formatarNumero(cliente.valor || 0)}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                clientesTable = '<p style="text-align: center; color: #6c757d; font-size: 12px;">Nenhum cliente encontrado</p>';
            }
            
            analiseMarcaSection.innerHTML = `
                <h3 style="color: #6f42c1; border-bottom: 1px solid #dee2e6; padding-bottom: 8px; margin-bottom: 15px; font-size: 20px;">
                    üìä An√°lise da Marca: ${dados.analise_marca.nome}
                </h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #e9ecef; padding: 12px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 20px; color: #6f42c1; font-weight: bold;">
                            ${dados.analise_marca.dados.total_nfs || 0}
                        </div>
                        <div style="color: #666; font-size: 11px;">NFs da Marca</div>
                    </div>
                    <div style="background: #e9ecef; padding: 12px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 20px; color: #6f42c1; font-weight: bold;">
                            R$ ${formatarNumero(dados.analise_marca.dados.total_valor || 0)}
                        </div>
                        <div style="color: #666; font-size: 11px;">Valor Total</div>
                    </div>
                    <div style="background: #e9ecef; padding: 12px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 20px; color: #6f42c1; font-weight: bold;">
                            ${dados.analise_marca.dados.total_quantidade || 0}
                        </div>
                        <div style="color: #666; font-size: 11px;">Quantidade</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                    <div>
                        <h4 style="color: #495057; font-size: 14px; margin-bottom: 10px;">üèÜ Top Produtos</h4>
                        ${produtosTable}
                    </div>
                    <div>
                        <h4 style="color: #495057; font-size: 14px; margin-bottom: 10px;">üè¢ Top Clientes</h4>
                        ${clientesTable}
                    </div>
                </div>
            `;
            container.appendChild(analiseMarcaSection);
        }
        
        // Footer
        const footer = document.createElement('div');
        footer.style.cssText = `
            text-align: center;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            color: #6c757d;
            font-size: 11px;
        `;
        footer.innerHTML = `
            <p style="margin: 0;">R.O Experience 2025 ‚Ä¢ Sistema de Gest√£o do Evento</p>
            <p style="margin: 5px 0 0 0;">Relat√≥rio gerado automaticamente ‚Ä¢ P√°gina 1/1</p>
        `;
        container.appendChild(footer);
        
        // Adicionar ao body temporariamente
        document.body.appendChild(container);
        
        // Fun√ß√£o para garantir que o logo seja carregado
        const waitForLogo = new Promise((resolve) => {
            const logoImg = container.querySelector('#logoRelatorio');
            if (!logoImg || logoImg.complete) {
                resolve();
                return;
            }
            
            logoImg.onload = resolve;
            logoImg.onerror = resolve; // Se der erro, continua mesmo sem logo
            setTimeout(resolve, 1000); // Timeout de seguran√ßa
        });
        
        // Esperar o logo carregar antes de gerar a imagem
        waitForLogo.then(() => {
            // Gerar imagem
            html2canvas(container, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false,
                width: container.offsetWidth,
                height: container.scrollHeight
            }).then(canvas => {
                // Remover container tempor√°rio
                document.body.removeChild(container);
                
                // Criar link para download
                const link = document.createElement('a');
                const dataAtual = new Date();
                const nomeArquivo = `relatorio_vendas_${dataAtual.getFullYear()}-${String(dataAtual.getMonth() + 1).padStart(2, '0')}-${String(dataAtual.getDate()).padStart(2, '0')}_${dataAtual.getTime()}.png`;
                link.download = nomeArquivo;
                link.href = canvas.toDataURL('image/png');
                
                // Fechar loading e mostrar sucesso
                loadingToast.close();
                
                // Mostrar preview e op√ß√£o de download
                Swal.fire({
                    title: 'Relat√≥rio Gerado!',
                    html: `
                        <div style="text-align: center;">
                            <p style="margin-bottom: 15px;">Relat√≥rio exportado com sucesso!</p>
                            <div style="margin: 15px 0; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #f8f9fa;">
                                <img src="${link.href}" style="max-width: 100%; border-radius: 4px;" />
                            </div>
                            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                                <strong>Arquivo:</strong> ${nomeArquivo}<br>
                                Clique no bot√£o abaixo para baixar
                            </p>
                        </div>
                    `,
                    showCancelButton: true,
                    cancelButtonText: 'Fechar',
                    confirmButtonText: 'üì• Download',
                    confirmButtonColor: '#28a745',
                    width: '700px',
                    customClass: {
                        popup: 'custom-swal-popup'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        link.click();
                        // Mostrar confirma√ß√£o
                        Swal.fire({
                            title: 'Download Iniciado!',
                            text: 'O arquivo est√° sendo baixado',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                });
                
            }).catch(error => {
                console.error('Erro ao gerar imagem:', error);
                document.body.removeChild(container);
                loadingToast.close();
                Swal.fire('Erro', 'N√£o foi poss√≠vel gerar a imagem do relat√≥rio', 'error');
            });
        });
        
    }).catch(error => {
        console.error('Erro ao obter dados:', error);
        loadingToast.close();
        Swal.fire('Erro', 'N√£o foi poss√≠vel obter os dados para o relat√≥rio', 'error');
    });
}
</script>

<style>
    /* ESTILOS M√çNIMOS para an√°lise de vendas - N√ÉO AFETA NAVBAR */
    
    /* Apenas para cards espec√≠ficos deste template */
    .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
    }
    
    /* Apenas para os gr√°ficos e tabelas DESTE template */
    #chartMarcas,
    #chartClientesCompradores,
    #chartTopProdutos,
    #chartDistribuicaoFamilia {
        max-height: 300px;
    }
    
    /* Apenas para tabelas DESTE template */
    #tabelaVendas th,
    #tabelaPorcentagemMarca th,
    #tabelaTopProdutosDetalhado th {
        font-weight: 600;
        background-color: #f8f9fa;
    }
    
    /* Apenas para pagina√ß√£o DESTE template */
    #paginacao .page-item.active .page-link {
        background-color: #28a745;
        border-color: #28a745;
    }
    
    /* Responsividade apenas para elementos deste template */
    @media (max-width: 768px) {
        #tabelaVendas,
        #tabelaPorcentagemMarca,
        #tabelaTopProdutosDetalhado {
            font-size: 0.9rem;
        }
        
        .display-4 {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}
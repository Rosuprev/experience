{% extends "base.html" %}

{% block content %}
<!-- Header do Dashboard de An√°lise -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-primary-custom text-white">
            <div class="card-body text-center py-4">
                <h1 class="display-5 mb-2">üìä An√°lise de Vendas - Evento 2025</h1>
                <p class="lead mb-0">Dashboard completo com m√©tricas de vendas, capilaridade e an√°lise por marca</p>
            </div>
        </div>
    </div>
</div>

<!-- Painel de Filtros -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm card-hover">
            <div class="card-header bg-success-custom text-white">
                <h6 class="mb-0">üîç Filtros de An√°lise</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label text-white"><strong>Cliente</strong></label>
                        <select class="form-select" id="filtroCliente">
                            <option value="todos">Todos os Clientes</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente }}">{{ cliente }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label text-white"><strong>Vendedor</strong></label>
                        <select class="form-select" id="filtroVendedor">
                            <option value="todos">Todos os Vendedores</option>
                            {% for vendedor in vendedores %}
                            <option value="{{ vendedor }}">{{ vendedor }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label text-white"><strong>Marca</strong></label>
                        <select class="form-select" id="filtroMarca">
                            <option value="todos">Todas as Marcas</option>
                            {% for marca in marcas %}
                            <option value="{{ marca }}">{{ marca }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label text-white"><strong>Equipe</strong></label>
                        <select class="form-select" id="filtroEquipe">
                            <option value="todos">Todas as Equipes</option>
                            {% for equipe in equipes %}
                            <option value="{{ equipe }}">{{ equipe }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label text-white"><strong>Fam√≠lia</strong></label>
                        <select class="form-select" id="filtroFamilia">
                            <option value="todos">Todas as Fam√≠lias</option>
                            {% for familia in familias %}
                            <option value="{{ familia }}">{{ familia }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label text-white"><strong>Data In√≠cio</strong></label>
                        <input type="date" class="form-control" id="filtroDataInicio" value="{{ min_date }}">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label text-white"><strong>Data Fim</strong></label>
                        <input type="date" class="form-control" id="filtroDataFim" value="{{ max_date }}">
                    </div>
                    <div class="col-lg-3 col-md-6 d-flex align-items-end">
                        <button class="btn btn-primary-custom w-100" onclick="aplicarFiltros()">
                            üîÑ Aplicar Filtros
                        </button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-success-custom" onclick="exportarParaExcel()">
                                üì• Exportar Excel
                            </button>
                            <button class="btn btn-warning text-white" onclick="exportarParaImagem()">
                                üìä Exportar Imagem
                            </button>
                            <button class="btn btn-secondary" onclick="resetarFiltros()">
                                üóëÔ∏è Limpar Filtros
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- M√©tricas Consolidadas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm stat-card card-hover">
            <div class="card-header bg-success-custom text-white">
                <h6 class="mb-0">üìà M√©tricas Consolidadas</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <!-- Total de Vendas (Valor) -->
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="card bg-light border-0 h-100 card-hover">
                            <div class="card-body py-3">
                                <h4 class="text-primary mb-1" id="totalValorVendas">R$ 0</h4>
                                <small class="text-muted">Total Vendas (Valor)</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total de NFs -->
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="card bg-light border-0 h-100 card-hover">
                            <div class="card-body py-3">
                                <h4 class="text-success mb-1" id="totalNFs">0</h4>
                                <small class="text-muted">Total de NFs</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total de Itens -->
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="card bg-light border-0 h-100 card-hover">
                            <div class="card-body py-3">
                                <h4 class="text-info mb-1" id="totalItens">0</h4>
                                <small class="text-muted">Total de Itens</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ticket M√©dio -->
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="card bg-light border-0 h-100 card-hover">
                            <div class="card-body py-3">
                                <h4 class="text-warning mb-1" id="ticketMedio">R$ 0</h4>
                                <small class="text-muted">Ticket M√©dio</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Consultor Top -->
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="card bg-light border-0 h-100 card-hover">
                            <div class="card-body py-3">
                                <h5 class="text-purple mb-1" id="topConsultor">N/A</h5>
                                <small class="text-muted">Consultor Top</small>
                                <div class="mt-1">
                                    <small class="text-success" id="topConsultorValor">R$ 0</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Revenda Top -->
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="card bg-light border-0 h-100 card-hover">
                            <div class="card-body py-3">
                                <h5 class="text-danger mb-1" id="topRevenda">N/A</h5>
                                <small class="text-muted">Revenda Top</small>
                                <div class="mt-1">
                                    <small class="text-success" id="topRevendaValor">R$ 0</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Distribui√ß√£o por Marca -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">üí∞ Distribui√ß√£o por Marca (Valor)</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="chartMarcas" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- An√°lise de Capilaridade -->
<div class="row mb-4">
    <!-- Capilaridade Geral -->
    <div class="col-lg-6 mb-4">
        <div class="card border-0 shadow-sm h-100 card-hover">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">üåê Capilaridade Geral</h6>
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-4">
                        <div class="card bg-light border-0">
                            <div class="card-body py-2">
                                <h5 class="text-info mb-1" id="capClientes">0</h5>
                                <small class="text-muted">Clientes</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card bg-light border-0">
                            <div class="card-body py-2">
                                <h5 class="text-success mb-1" id="capVendedores">0</h5>
                                <small class="text-muted">Vendedores</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card bg-light border-0">
                            <div class="card-body py-2">
                                <h5 class="text-warning mb-1" id="capMarcas">0</h5>
                                <small class="text-muted">Marcas</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <div class="card bg-light border-0">
                            <div class="card-body py-2">
                                <h5 class="text-secondary mb-1" id="capMediaItensNF">0.0</h5>
                                <small class="text-muted">M√©dia Itens/NF</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-light border-0">
                            <div class="card-body py-2">
                                <h5 class="text-secondary mb-1" id="capMediaValorNF">R$ 0</h5>
                                <small class="text-muted">M√©dia Valor/NF</small>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
        </div>
    </div>
    
    <!-- Capilaridade por Marca -->
    <div class="col-lg-6 mb-4">
        <div class="card border-0 shadow-sm h-100 card-hover">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">üè∑Ô∏è Top 10 Marcas</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Marca</th>
                                <th>NFs</th>
                                <th>Clientes</th>
                                <th>Vendedores</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaCapilaridadeMarca">
                            <tr>
                                <td colspan="5" class="text-center text-muted">Carregando dados...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- An√°lise Detalhada por Marca -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm card-hover">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">üìä An√°lise por Marca</h6>
                    <div class="col-md-4">
                        <select class="form-select" id="selecionarMarca" onchange="carregarAnaliseMarca(this.value)">
                            <option value="">Selecione uma marca</option>
                            {% for marca in marcas %}
                            <option value="{{ marca }}">{{ marca }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- M√©tricas da Marca Selecionada -->
                <div class="row mb-4" id="metricasMarca">
                    <div class="col-12 text-center py-4">
                        <p class="text-muted">Selecione uma marca para ver a an√°lise detalhada</p>
                    </div>
                </div>
                
                <div class="row" id="conteudoMarca" style="display: none;">
                    <!-- Top Itens Vendidos -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 card-hover">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">üèÜ Top Itens</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                    <table class="table table-sm">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Produto</th>
                                                <th>NFs</th>
                                                <th>Qtd</th>
                                                <th>Valor</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabelaTopItens">
                                            <!-- Dados ser√£o preenchidos via JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Consultores -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 card-hover">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">üë• Top Consultores</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                    <table class="table table-sm">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Consultor</th>
                                                <th>NFs</th>
                                                <th>Clientes</th>
                                                <th>Valor</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabelaTopConsultores">
                                            <!-- Dados ser√£o preenchidos via JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row" id="conteudoMarca2" style="display: none;">
                    <!-- Top Clientes -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 card-hover">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">üè¢ Top Clientes</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                    <table class="table table-sm">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Cliente</th>
                                                <th>NFs</th>
                                                <th>Valor</th>
                                                <th>Ticket M√©dio</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabelaTopClientes">
                                            <!-- Dados ser√£o preenchidos via JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Distribui√ß√£o por Fam√≠lia -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 card-hover">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">üì¶ Fam√≠lias</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="chartDistribuicaoFamilia" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabela Detalhada de Vendas -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm card-hover">
            <div class="card-header bg-dark text-white">
                <h6 class="mb-0">üìã Vendas Detalhadas</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="tabelaVendas">
                        <thead class="table-dark">
                            <tr>
                                <th>NF</th>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Vendedor</th>
                                <th>Equipe</th>
                                <th>Produto</th>
                                <th>Marca</th>
                                <th>Fam√≠lia</th>
                                <th>Qtd</th>
                                <th>Valor Unit.</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaVendas">
                            <tr>
                                <td colspan="11" class="text-center">Carregando dados...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Pagina√ß√£o -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <span class="me-2 text-muted">Itens por p√°gina:</span>
                            <select class="form-select form-select-sm w-auto" id="itensPorPagina" onchange="carregarVendasFiltradas()">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <nav aria-label="Pagina√ß√£o">
                            <ul class="pagination justify-content-end" id="paginacao">
                                <!-- Pagina√ß√£o ser√° gerada via JS -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bot√£o Voltar -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <a href="{{ url_for('index') }}" class="btn btn-primary-custom btn-lg">
            üè† Voltar para P√°gina Inicial
        </a>
    </div>
</div>

<!-- Incluir Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
// Vari√°veis globais
let vendasFiltradas = [];
let paginaAtual = 1;
let itensPorPagina = 50;
let graficoMarcas = null;
let graficoCapilaridadeGeral = null;
let graficoDistribuicaoFamilia = null;

// Inicializar dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log("üîß Inicializando dashboard de an√°lise...");
    carregarDadosIniciais();
});

// Carregar dados iniciais
function carregarDadosIniciais() {
    // Carregar m√©tricas usando a rota existente
    fetch('/api/metricas-vendas')
    .then(response => response.json())
    .then(data => {
        console.log("üìà M√©tricas iniciais:", data);
        atualizarMetricasIniciais(data);
    })
    .catch(error => {
        console.error("‚ùå Erro ao carregar m√©tricas:", error);
    });
    
    // Carregar capilaridade
    carregarCapilaridade();
    
    // Carregar vendas iniciais
    carregarVendasFiltradas();
}

// Atualizar m√©tricas iniciais
function atualizarMetricasIniciais(data) {
    // Total de vendas
    if (data.totais_por_nf) {
        document.getElementById('totalValorVendas').textContent = 
            'R$ ' + formatarNumero(data.totais_por_nf.total_valor || 0);
        document.getElementById('totalNFs').textContent = data.totais_por_nf.total_nfs || 0;
        document.getElementById('totalItens').textContent = data.totais_por_nf.total_itens || 0;
        document.getElementById('ticketMedio').textContent = 
            'R$ ' + formatarNumero(data.totais_por_nf.media_valor_por_nf || 0);
    }
    
    // Consultor top
    if (data.vendedores?.maior_valor) {
        document.getElementById('topConsultor').textContent = 
            data.vendedores.maior_valor.nome?.substring(0, 20) || 'N/A';
        document.getElementById('topConsultorValor').textContent = 
            'R$ ' + formatarNumero(data.vendedores.maior_valor.valor || 0);
    }
    
    // Revenda top
    if (data.clientes?.maior_valor) {
        document.getElementById('topRevenda').textContent = 
            data.clientes.maior_valor.nome?.substring(0, 20) || 'N/A';
        document.getElementById('topRevendaValor').textContent = 
            'R$ ' + formatarNumero(data.clientes.maior_valor.valor || 0);
    }
    
    // Criar gr√°fico de marcas
    if (data.marcas_por_nf && data.marcas_por_nf.length > 0) {
        criarGraficoMarcas(data.marcas_por_nf);
    }
}

// Fun√ß√£o para aplicar filtros
function aplicarFiltros() {
    console.log("üîç Aplicando filtros...");
    paginaAtual = 1;
    carregarMetricasComFiltros();
    carregarCapilaridadeComFiltros();
    carregarVendasFiltradas();
    
    // Resetar an√°lise de marca
    document.getElementById('selecionarMarca').value = '';
    document.getElementById('conteudoMarca').style.display = 'none';
    document.getElementById('conteudoMarca2').style.display = 'none';
    document.getElementById('metricasMarca').innerHTML = `
        <div class="col-12 text-center py-4">
            <p class="text-muted">Selecione uma marca para ver a an√°lise detalhada</p>
        </div>
    `;
}

// Carregar m√©tricas com filtros
function carregarMetricasComFiltros() {
    const filtros = obterFiltros();
    console.log("üìä Carregando m√©tricas com filtros:", filtros);
    
    // 1. Primeiro pega os totais b√°sicos da rota /api/vendas-filtradas
    fetch('/api/vendas-filtradas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            ...filtros,
            page: 1,
            per_page: 1  // Apenas para contar
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log("üìà Dados b√°sicos filtrados:", data);
        
        // Atualizar m√©tricas b√°sicas
        document.getElementById('totalValorVendas').textContent = 
            'R$ ' + formatarNumero(data.total_valor || 0);
        document.getElementById('totalNFs').textContent = data.total_vendas || 0;
        document.getElementById('totalItens').textContent = data.total_quantidade || 0;
        
        // Calcular ticket m√©dio
        const ticketMedio = data.total_valor / (data.total_vendas || 1);
        document.getElementById('ticketMedio').textContent = 
            'R$ ' + formatarNumero(ticketMedio);
        
        // 2. Agora busca os tops da rota /api/metricas-vendas-filtradas
        return fetch('/api/metricas-vendas-filtradas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filtros)
        });
    })
    .then(response => response.json())
    .then(data => {
        console.log("üèÜ Dados tops filtrados:", data);
        
        // Top consultor
        if (data.vendedores?.maior_valor?.nome) {
            document.getElementById('topConsultor').textContent = 
                data.vendedores.maior_valor.nome.length > 20 ? 
                data.vendedores.maior_valor.nome.substring(0, 20) + '...' : 
                data.vendedores.maior_valor.nome;
            document.getElementById('topConsultorValor').textContent = 
                'R$ ' + formatarNumero(data.vendedores.maior_valor.valor || 0);
        } else {
            document.getElementById('topConsultor').textContent = 'N/A';
            document.getElementById('topConsultorValor').textContent = 'R$ 0';
        }
        
        // Top revenda
        if (data.clientes?.maior_valor?.nome) {
            document.getElementById('topRevenda').textContent = 
                data.clientes.maior_valor.nome.length > 20 ? 
                data.clientes.maior_valor.nome.substring(0, 20) + '...' : 
                data.clientes.maior_valor.nome;
            document.getElementById('topRevendaValor').textContent = 
                'R$ ' + formatarNumero(data.clientes.maior_valor.valor || 0);
        } else {
            document.getElementById('topRevenda').textContent = 'N/A';
            document.getElementById('topRevendaValor').textContent = 'R$ 0';
        }
        
        // Atualizar gr√°fico de marcas
        if (data.marcas_por_nf && data.marcas_por_nf.length > 0) {
            criarGraficoMarcas(data.marcas_por_nf);
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao carregar m√©tricas com filtros:', error);
    });
}

// Carregar capilaridade com filtros
function carregarCapilaridadeComFiltros() {
    const filtros = obterFiltros();
    
    fetch('/api/capilaridade-vendas-filtradas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(filtros)
    })
    .then(response => response.json())
    .then(data => {
        console.log("üåê Dados de capilaridade com filtros:", data);
        
        // Atualizar m√©tricas de capilaridade
        if (data.estatisticas_gerais) {
            document.getElementById('capClientes').textContent = data.estatisticas_gerais.total_clientes || 0;
            document.getElementById('capVendedores').textContent = data.estatisticas_gerais.total_vendedores || 0;
            document.getElementById('capMarcas').textContent = data.estatisticas_gerais.total_marcas || 0;
            document.getElementById('capMediaItensNF').textContent = 
                (data.estatisticas_gerais.media_itens_por_nf || 0).toFixed(1);
            document.getElementById('capMediaValorNF').textContent = 
                'R$ ' + formatarNumero(data.estatisticas_gerais.media_valor_por_nf || 0);
        }
        
        // Atualizar tabela de capilaridade por marca
        if (data.capilaridade_marca && data.capilaridade_marca.length > 0) {
            atualizarTabelaCapilaridadeMarca(data.capilaridade_marca);
        } else {
            document.getElementById('tabelaCapilaridadeMarca').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted">Nenhuma marca encontrada</td>
                </tr>
            `;
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao carregar capilaridade com filtros:', error);
    });
}

// Carregar vendas filtradas
function carregarVendasFiltradas() {
    const filtros = obterFiltros();
    filtros.page = paginaAtual;
    filtros.per_page = parseInt(document.getElementById('itensPorPagina').value);
    
    console.log("üìã Carregando vendas com filtros:", filtros);
    
    fetch('/api/vendas-filtradas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(filtros)
    })
    .then(response => response.json())
    .then(data => {
        console.log("‚úÖ Vendas carregadas:", data.vendas?.length || 0, "itens");
        vendasFiltradas = data.vendas || [];
        
        // Atualizar tabela
        atualizarTabelaVendas(vendasFiltradas);
        
        // Atualizar pagina√ß√£o
        atualizarPaginacao(data.total_vendas || 0, data.page || 1, data.pages || 1);
    })
    .catch(error => {
        console.error('‚ùå Erro ao carregar vendas filtradas:', error);
        document.getElementById('corpoTabelaVendas').innerHTML = `
            <tr>
                <td colspan="11" class="text-center text-danger">
                    Erro ao carregar dados
                </td>
            </tr>
        `;
    });
}

// Fun√ß√£o inicial - Carregar dados sem filtros
function carregarDadosIniciais() {
    console.log("üîß Inicializando dashboard de an√°lise...");
    
    // Carregar m√©tricas iniciais (sem filtros)
    fetch('/api/metricas-vendas')
    .then(response => response.json())
    .then(data => {
        console.log("üìà M√©tricas iniciais:", data);
        
        // Atualizar m√©tricas b√°sicas
        if (data.totais_por_nf) {
            document.getElementById('totalValorVendas').textContent = 
                'R$ ' + formatarNumero(data.totais_por_nf.total_valor || 0);
            document.getElementById('totalNFs').textContent = data.totais_por_nf.total_nfs || 0;
            document.getElementById('totalItens').textContent = data.totais_por_nf.total_itens || 0;
            document.getElementById('ticketMedio').textContent = 
                'R$ ' + formatarNumero(data.totais_por_nf.media_valor_por_nf || 0);
        }
        
        // Top consultor
        if (data.vendedores?.maior_valor?.nome) {
            document.getElementById('topConsultor').textContent = 
                data.vendedores.maior_valor.nome.length > 20 ? 
                data.vendedores.maior_valor.nome.substring(0, 20) + '...' : 
                data.vendedores.maior_valor.nome;
            document.getElementById('topConsultorValor').textContent = 
                'R$ ' + formatarNumero(data.vendedores.maior_valor.valor || 0);
        }
        
        // Top revenda
        if (data.clientes?.maior_valor?.nome) {
            document.getElementById('topRevenda').textContent = 
                data.clientes.maior_valor.nome.length > 20 ? 
                data.clientes.maior_valor.nome.substring(0, 20) + '...' : 
                data.clientes.maior_valor.nome;
            document.getElementById('topRevendaValor').textContent = 
                'R$ ' + formatarNumero(data.clientes.maior_valor.valor || 0);
        }
        
        // Gr√°fico de marcas
        if (data.marcas_por_nf && data.marcas_por_nf.length > 0) {
            criarGraficoMarcas(data.marcas_por_nf);
        }
    })
    .catch(error => {
        console.error("‚ùå Erro ao carregar m√©tricas iniciais:", error);
    });
    
    // Carregar capilaridade inicial
    fetch('/api/capilaridade-vendas')
    .then(response => response.json())
    .then(data => {
        console.log("üåê Capilaridade inicial:", data);
        
        if (data.estatisticas_gerais) {
            document.getElementById('capClientes').textContent = data.estatisticas_gerais.total_clientes || 0;
            document.getElementById('capVendedores').textContent = data.estatisticas_gerais.total_vendedores || 0;
            document.getElementById('capMarcas').textContent = data.estatisticas_gerais.total_marcas || 0;
            document.getElementById('capMediaItensNF').textContent = 
                (data.estatisticas_gerais.media_itens_por_nf || 0).toFixed(1);
            document.getElementById('capMediaValorNF').textContent = 
                'R$ ' + formatarNumero(data.estatisticas_gerais.media_valor_por_nf || 0);
        }
        
        if (data.capilaridade_marca && data.capilaridade_marca.length > 0) {
            atualizarTabelaCapilaridadeMarca(data.capilaridade_marca);
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao carregar capilaridade inicial:', error);
    });
    
    // Carregar vendas iniciais
    carregarVendasFiltradas();
}

// Inicializar quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    carregarDadosIniciais();
});

// Obter filtros atuais
function obterFiltros() {
    return {
        cliente: document.getElementById('filtroCliente').value,
        vendedor: document.getElementById('filtroVendedor').value,
        marca: document.getElementById('filtroMarca').value,
        equipe: document.getElementById('filtroEquipe').value,
        familia: document.getElementById('filtroFamilia').value,
        data_inicio: document.getElementById('filtroDataInicio').value,
        data_fim: document.getElementById('filtroDataFim').value,
        sort_by: 'data_emissao',
        sort_order: 'desc'
    };
}

// Fun√ß√£o para resetar filtros
function resetarFiltros() {
    document.getElementById('filtroCliente').value = 'todos';
    document.getElementById('filtroVendedor').value = 'todos';
    document.getElementById('filtroMarca').value = 'todos';
    document.getElementById('filtroEquipe').value = 'todos';
    document.getElementById('filtroFamilia').value = 'todos';
    document.getElementById('filtroDataInicio').value = '{{ min_date }}';
    document.getElementById('filtroDataFim').value = '{{ max_date }}';
    paginaAtual = 1;
    aplicarFiltros();
}

// Fun√ß√µes auxiliares
function formatarNumero(valor) {
    return parseFloat(valor || 0).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Carregar capilaridade
function carregarCapilaridade() {
    fetch('/api/capilaridade-vendas')
    .then(response => response.json())
    .then(data => {
        console.log("üåê Dados de capilaridade:", data);
        
        // Atualizar m√©tricas de capilaridade
        if (data.estatisticas_gerais) {
            document.getElementById('capClientes').textContent = data.estatisticas_gerais.total_clientes || 0;
            document.getElementById('capVendedores').textContent = data.estatisticas_gerais.total_vendedores || 0;
            document.getElementById('capMarcas').textContent = data.estatisticas_gerais.total_marcas || 0;
            document.getElementById('capMediaItensNF').textContent = 
                (data.estatisticas_gerais.media_itens_por_nf || 0).toFixed(1);
            document.getElementById('capMediaValorNF').textContent = 
                'R$ ' + formatarNumero(data.estatisticas_gerais.media_valor_por_nf || 0);
        }
        
        // Atualizar tabela de capilaridade por marca
        if (data.capilaridade_marca && data.capilaridade_marca.length > 0) {
            atualizarTabelaCapilaridadeMarca(data.capilaridade_marca);
        } else {
            document.getElementById('tabelaCapilaridadeMarca').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted">Nenhum dado encontrado</td>
                </tr>
            `;
        }
        
        // Criar gr√°fico de capilaridade geral
        criarGraficoCapilaridadeGeral(data);
    })
    .catch(error => {
        console.error('‚ùå Erro ao carregar capilaridade:', error);
    });
}

// Carregar an√°lise de marca espec√≠fica
function carregarAnaliseMarca(marca) {
    if (!marca) {
        document.getElementById('conteudoMarca').style.display = 'none';
        document.getElementById('conteudoMarca2').style.display = 'none';
        document.getElementById('metricasMarca').innerHTML = `
            <div class="col-12 text-center py-4">
                <p class="text-muted">Selecione uma marca para ver a an√°lise detalhada</p>
            </div>
        `;
        return;
    }
    
    console.log(`üìä Carregando an√°lise da marca: ${marca}`);
    
    // Usar a rota existente
    fetch(`/api/analise-marca/${encodeURIComponent(marca)}`)
    .then(response => response.json())
    .then(data => {
        console.log(`‚úÖ Dados da marca ${marca}:`, data);
        
        // Mostrar conte√∫do
        document.getElementById('conteudoMarca').style.display = 'flex';
        document.getElementById('conteudoMarca2').style.display = 'flex';
        
        // Atualizar m√©tricas da marca
        if (data.dados_gerais) {
            const metricasHtml = `
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card bg-light border-0 h-100 card-hover">
                        <div class="card-body text-center py-3">
                            <h4 class="text-primary mb-1">${data.dados_gerais.total_nfs || 0}</h4>
                            <small class="text-muted">NFs da Marca</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card bg-light border-0 h-100 card-hover">
                        <div class="card-body text-center py-3">
                            <h4 class="text-success mb-1">R$ ${formatarNumero(data.dados_gerais.total_valor || 0)}</h4>
                            <small class="text-muted">Valor Total</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card bg-light border-0 h-100 card-hover">
                        <div class="card-body text-center py-3">
                            <h4 class="text-warning mb-1">${data.dados_gerais.total_quantidade || 0}</h4>
                            <small class="text-muted">Quantidade Total</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card bg-light border-0 h-100 card-hover">
                        <div class="card-body text-center py-3">
                            <h4 class="text-info mb-1">R$ ${formatarNumero(data.dados_gerais.valor_medio_unitario || 0)}</h4>
                            <small class="text-muted">Ticket M√©dio</small>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('metricasMarca').innerHTML = metricasHtml;
        }
        
        // Atualizar tabelas
        if (data.top_produtos && data.top_produtos.length > 0) {
            atualizarTabelaTopItens(data.top_produtos);
        } else {
            document.getElementById('tabelaTopItens').innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted">Nenhum produto encontrado</td>
                </tr>
            `;
        }
        
        if (data.top_vendedores && data.top_vendedores.length > 0) {
            atualizarTabelaTopConsultores(data.top_vendedores);
        } else {
            document.getElementById('tabelaTopConsultores').innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted">Nenhum consultor encontrado</td>
                </tr>
            `;
        }
        
        if (data.top_clientes && data.top_clientes.length > 0) {
            atualizarTabelaTopClientes(data.top_clientes);
        } else {
            document.getElementById('tabelaTopClientes').innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted">Nenhum cliente encontrado</td>
                </tr>
            `;
        }
        
        // Criar gr√°fico de distribui√ß√£o por fam√≠lia
        if (data.distribuicao_familia && data.distribuicao_familia.length > 0) {
            criarGraficoDistribuicaoFamilia(data.distribuicao_familia);
        }
    })
    .catch(error => {
        console.error(`‚ùå Erro ao carregar an√°lise da marca ${marca}:`, error);
        document.getElementById('metricasMarca').innerHTML = `
            <div class="col-12 text-center py-4">
                <p class="text-danger">Erro ao carregar dados da marca</p>
            </div>
        `;
    });
}

// Carregar vendas filtradas
function carregarVendasFiltradas() {
    const filtros = obterFiltros();
    filtros.page = paginaAtual;
    filtros.per_page = parseInt(document.getElementById('itensPorPagina').value);
    
    console.log("üìã Carregando vendas com filtros:", filtros);
    
    // Usar a rota existente
    fetch('/api/vendas-filtradas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(filtros)
    })
    .then(response => response.json())
    .then(data => {
        console.log("‚úÖ Vendas carregadas:", data.vendas?.length || 0, "itens");
        vendasFiltradas = data.vendas || [];
        
        // Atualizar tabela
        atualizarTabelaVendas(vendasFiltradas);
        
        // Atualizar pagina√ß√£o
        if (data.total_vendas) {
            atualizarPaginacao(data.total_vendas, data.page || 1, data.pages || 1);
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao carregar vendas filtradas:', error);
        document.getElementById('corpoTabelaVendas').innerHTML = `
            <tr>
                <td colspan="11" class="text-center text-danger">
                    Erro ao carregar dados
                </td>
            </tr>
        `;
    });
}

// Obter filtros atuais
function obterFiltros() {
    return {
        cliente: document.getElementById('filtroCliente').value,
        vendedor: document.getElementById('filtroVendedor').value,
        marca: document.getElementById('filtroMarca').value,
        equipe: document.getElementById('filtroEquipe').value,
        familia: document.getElementById('filtroFamilia').value,
        data_inicio: document.getElementById('filtroDataInicio').value,
        data_fim: document.getElementById('filtroDataFim').value,
        sort_by: 'data_emissao',
        sort_order: 'desc'
    };
}

// Criar gr√°fico de marcas
function criarGraficoMarcas(dadosMarcas) {
    const ctx = document.getElementById('chartMarcas');
    if (!ctx) {
        console.error("‚ùå Elemento chartMarcas n√£o encontrado!");
        return;
    }
    
    // Destruir gr√°fico anterior se existir
    if (graficoMarcas) {
        graficoMarcas.destroy();
    }
    
    // Preparar dados
    const labels = dadosMarcas.map(marca => marca.marca || 'Desconhecida');
    const valores = dadosMarcas.map(marca => marca.valor || 0);
    
    // Cores do dashboard original
    const cores = [
        '#28a745', '#20c997', '#17a2b8', '#007bff', '#6f42c1',
        '#e83e8c', '#fd7e14', '#ffc107', '#dc3545', '#343a40'
    ];
    
    graficoMarcas = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.slice(0, 10), // Mostrar apenas top 10
            datasets: [{
                label: 'Valor (R$)',
                data: valores.slice(0, 10),
                backgroundColor: cores.slice(0, Math.min(valores.length, 10)),
                borderColor: cores.slice(0, Math.min(valores.length, 10)),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `R$ ${formatarNumero(context.raw)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + formatarNumero(value);
                        }
                    }
                }
            }
        }
    });
}



// Criar gr√°fico de distribui√ß√£o por fam√≠lia
function criarGraficoDistribuicaoFamilia(dadosFamilia) {
    const ctx = document.getElementById('chartDistribuicaoFamilia');
    if (!ctx) return;
    
    // Destruir gr√°fico anterior se existir
    if (graficoDistribuicaoFamilia) {
        graficoDistribuicaoFamilia.destroy();
    }
    
    // Preparar dados
    const labels = dadosFamilia.map(item => item.familia || 'Sem Fam√≠lia');
    const valores = dadosFamilia.map(item => item.valor || 0);
    
    // Cores
    const cores = [
        '#28a745', '#20c997', '#17a2b8', '#007bff', '#6f42c1',
        '#e83e8c', '#fd7e14', '#ffc107', '#dc3545', '#343a40'
    ];
    
    graficoDistribuicaoFamilia = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: valores,
                backgroundColor: cores.slice(0, valores.length),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
}

// Atualizar tabela de capilaridade por marca
function atualizarTabelaCapilaridadeMarca(dados) {
    const tbody = document.getElementById('tabelaCapilaridadeMarca');
    let html = '';
    
    dados.slice(0, 10).forEach((marca, index) => {
        html += `
            <tr>
                <td><strong>${marca.marca || 'Desconhecida'}</strong></td>
                <td><span class="badge bg-primary">${marca.total_nfs || 0}</span></td>
                <td>${marca.clientes_diferentes || 0}</td>
                <td>${marca.vendedores_diferentes || 0}</td>
                <td><strong class="text-success">R$ ${formatarNumero(marca.valor_total || 0)}</strong></td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Atualizar tabela de top itens
function atualizarTabelaTopItens(dados) {
    const tbody = document.getElementById('tabelaTopItens');
    let html = '';
    
    dados.slice(0, 10).forEach(item => {
        html += `
            <tr>
                <td>${item.produto || 'Desconhecido'}</td>
                <td><span class="badge bg-info">${item.nfs || 0}</span></td>
                <td>${item.quantidade || 0}</td>
                <td><strong class="text-success">R$ ${formatarNumero(item.valor || 0)}</strong></td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Atualizar tabela de top consultores
function atualizarTabelaTopConsultores(dados) {
    const tbody = document.getElementById('tabelaTopConsultores');
    let html = '';
    
    dados.slice(0, 10).forEach(consultor => {
        html += `
            <tr>
                <td>${consultor.vendedor || 'Desconhecido'}</td>
                <td><span class="badge bg-success">${consultor.nfs || 0}</span></td>
                <td>${consultor.clientes_atendidos || 0}</td>
                <td><strong class="text-success">R$ ${formatarNumero(consultor.valor || 0)}</strong></td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Atualizar tabela de top clientes
function atualizarTabelaTopClientes(dados) {
    const tbody = document.getElementById('tabelaTopClientes');
    let html = '';
    
    dados.slice(0, 10).forEach(cliente => {
        const ticketMedio = cliente.valor / (cliente.nfs || 1);
        html += `
            <tr>
                <td>${cliente.cliente || 'Desconhecido'}</td>
                <td><span class="badge bg-warning">${cliente.nfs || 0}</span></td>
                <td><strong class="text-success">R$ ${formatarNumero(cliente.valor || 0)}</strong></td>
                <td>R$ ${formatarNumero(ticketMedio)}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Atualizar tabela de vendas
function atualizarTabelaVendas(dados) {
    const tbody = document.getElementById('corpoTabelaVendas');
    let html = '';
    
    if (dados.length === 0) {
        html = `
            <tr>
                <td colspan="11" class="text-center text-muted">
                    Nenhuma venda encontrada
                </td>
            </tr>
        `;
    } else {
        dados.forEach(venda => {
            html += `
                <tr>
                    <td><code>${venda.numero_nf || 'N/A'}</code></td>
                    <td>${venda.data_emissao || ''}</td>
                    <td>${venda.cliente_nome || ''}</td>
                    <td>${venda.vendedor || ''}</td>
                    <td><span class="badge bg-secondary">${venda.equipe || ''}</span></td>
                    <td>${venda.descricao_produto || ''}</td>
                    <td><span class="badge" style="background-color: #28a745;">${venda.marca || ''}</span></td>
                    <td>${venda.familia || 'N/A'}</td>
                    <td>${venda.quantidade || 0}</td>
                    <td>R$ ${formatarNumero(venda.valor_unitario || 0)}</td>
                    <td><strong class="text-success">R$ ${formatarNumero(venda.valor_total || 0)}</strong></td>
                </tr>
            `;
        });
    }
    
    tbody.innerHTML = html;
}

// Atualizar pagina√ß√£o
function atualizarPaginacao(total, pagina, totalPaginas) {
    const paginacao = document.getElementById('paginacao');
    let html = '';
    
    if (totalPaginas <= 1) {
        paginacao.innerHTML = '';
        return;
    }
    
    // Bot√£o anterior
    html += `
        <li class="page-item ${pagina === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="mudarPagina(${pagina - 1}); return false;">
                &laquo;
            </a>
        </li>
    `;
    
    // P√°ginas
    const inicio = Math.max(1, pagina - 2);
    const fim = Math.min(totalPaginas, pagina + 2);
    
    for (let i = inicio; i <= fim; i++) {
        html += `
            <li class="page-item ${i === pagina ? 'active' : ''}">
                <a class="page-link" href="#" onclick="mudarPagina(${i}); return false;">${i}</a>
            </li>
        `;
    }
    
    // Bot√£o pr√≥ximo
    html += `
        <li class="page-item ${pagina === totalPaginas ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="mudarPagina(${pagina + 1}); return false;">
                &raquo;
            </a>
        </li>
    `;
    
    paginacao.innerHTML = html;
}

// Mudar p√°gina
function mudarPagina(novaPagina) {
    paginaAtual = novaPagina;
    carregarVendasFiltradas();
}

// Exportar para Excel
function exportarParaExcel() {
    const filtros = obterFiltros();
    const params = new URLSearchParams();
    
    Object.keys(filtros).forEach(key => {
        if (filtros[key]) {
            params.append(key, filtros[key]);
        }
    });
    
    window.location.href = `/exportar-vendas-filtradas?${params.toString()}`;
}

// Exportar para Imagem
function exportarParaImagem() {
    html2canvas(document.querySelector(".container-fluid")).then(canvas => {
        const link = document.createElement('a');
        link.download = `relatorio_vendas_${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    });
}

// Fun√ß√µes auxiliares
function formatarNumero(valor) {
    return parseFloat(valor || 0).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}
</script>

<style>
    /* ESTILOS M√çNIMOS para an√°lise de vendas - N√ÉO AFETA NAVBAR */
    
    /* Apenas para cards espec√≠ficos deste template */
    .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
    }
    
    /* Apenas para os gr√°ficos e tabelas DESTE template */
    #chartMarcas,
    #chartDistribuicaoFamilia {
        max-height: 300px;
    }
    
    /* Apenas para tabelas DESTE template */
    #tabelaVendas th,
    #tabelaCapilaridadeMarca th,
    #tabelaTopItens th,
    #tabelaTopConsultores th,
    #tabelaTopClientes th {
        font-weight: 600;
        background-color: #f8f9fa;
    }
    
    /* Apenas para pagina√ß√£o DESTE template */
    #paginacao .page-item.active .page-link {
        background-color: #28a745;
        border-color: #28a745;
    }
    
    /* Responsividade apenas para elementos deste template */
    @media (max-width: 768px) {
        #tabelaVendas,
        #tabelaCapilaridadeMarca,
        #tabelaTopItens,
        #tabelaTopConsultores,
        #tabelaTopClientes {
            font-size: 0.9rem;
        }
    }
    </style>
{% endblock %}
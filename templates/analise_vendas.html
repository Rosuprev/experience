{% extends "base.html" %}

{% block content %}
<style>
    /* ADICIONAR ESTE CONTAINER PARA ESCALA 90% */
    .analise-container {
        transform: scale(0.9);
        transform-origin: top center;
        width: 111.11%;
        margin-left: -5.56%;
        margin-top: -20px;
    }
</style>

<div class="analise-container">
    <!-- Header do Dashboard de An√°lise -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary-custom text-white">
                <div class="card-body text-center py-4">
                    <h1 class="display-5 mb-2">üìä An√°lise de Vendas - Evento 2025</h1>
                    <p class="lead mb-0">Dashboard completo com m√©tricas de vendas, capilaridade e an√°lise por marca</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Painel de Filtros - AJUSTAR CORES -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm card-hover">
                <div class="card-header" style="background: linear-gradient(135deg, var(--accent-olive) 0%, var(--accent-green) 100%); color: white;">
                    <h6 class="mb-0">üîç Filtros de An√°lise</h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label" style="color: var(--primary-dark); font-weight: 600;">Cliente</label>
                            <select class="form-select" id="filtroCliente" style="border: 2px solid var(--primary-light);">
                                <option value="todos">Todos os Clientes</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente }}">{{ cliente }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label" style="color: var(--primary-dark); font-weight: 600;">Vendedor</label>
                            <select class="form-select" id="filtroVendedor" style="border: 2px solid var(--primary-light);">
                                <option value="todos">Todos os Vendedores</option>
                                {% for vendedor in vendedores %}
                                <option value="{{ vendedor }}">{{ vendedor }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label" style="color: var(--primary-dark); font-weight: 600;">Marca</label>
                            <select class="form-select" id="filtroMarca" style="border: 2px solid var(--primary-light);">
                                <option value="todos">Todas as Marcas</option>
                                {% for marca in marcas %}
                                <option value="{{ marca }}">{{ marca }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label" style="color: var(--primary-dark); font-weight: 600;">Equipe</label>
                            <select class="form-select" id="filtroEquipe" style="border: 2px solid var(--primary-light);">
                                <option value="todos">Todas as Equipes</option>
                                {% for equipe in equipes %}
                                <option value="{{ equipe }}">{{ equipe }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label" style="color: var(--primary-dark); font-weight: 600;">Fam√≠lia</label>
                            <select class="form-select" id="filtroFamilia" style="border: 2px solid var(--primary-light);">
                                <option value="todos">Todas as Fam√≠lias</option>
                                {% for familia in familias %}
                                <option value="{{ familia }}">{{ familia }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label" style="color: var(--primary-dark); font-weight: 600;">Data In√≠cio</label>
                            <input type="date" class="form-control" id="filtroDataInicio" value="{{ min_date }}" style="border: 2px solid var(--primary-light);">
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label" style="color: var(--primary-dark); font-weight: 600;">Data Fim</label>
                            <input type="date" class="form-control" id="filtroDataFim" value="{{ max_date }}" style="border: 2px solid var(--primary-light);">
                        </div>
                        <div class="col-lg-3 col-md-6 d-flex align-items-end">
                            <button class="btn w-100" style="background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-olive) 100%); color: white; font-weight: 600; border: none; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);" 
                                    onmouseover="this.style.boxShadow='0 4px 12px rgba(100, 148, 28, 0.4)'; this.style.transform='translateY(-2px)'" 
                                    onmouseout="this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)'; this.style.transform='translateY(0)'"
                                    onclick="aplicarFiltros()">
                                üîÑ Aplicar Filtros
                            </button>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <button class="btn" style="background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-olive) 100%); color: white; font-weight: 600; border: none; padding: 10px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"
                                        onmouseover="this.style.boxShadow='0 4px 12px rgba(66, 109, 35, 0.4)'; this.style.transform='translateY(-2px)'" 
                                        onmouseout="this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)'; this.style.transform='translateY(0)'"
                                        onclick="exportarParaExcel()">
                                    üì• Exportar Excel
                                </button>
                                <button class="btn" style="background: linear-gradient(135deg, var(--accent-yellow) 0%, #e6ff00 100%); color: var(--primary-dark); font-weight: 600; border: none; padding: 10px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"
                                        onmouseover="this.style.boxShadow='0 4px 12px rgba(206, 240, 5, 0.4)'; this.style.transform='translateY(-2px)'" 
                                        onmouseout="this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)'; this.style.transform='translateY(0)'"
                                        onclick="exportarParaImagem()" id="btnExportarImagem">
                                    üì∏ Exportar Imagem do Relat√≥rio
                                </button>
                                <button class="btn" style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; font-weight: 600; border: none; padding: 10px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"
                                        onmouseover="this.style.boxShadow='0 4px 12px rgba(108, 117, 125, 0.4)'; this.style.transform='translateY(-2px)'" 
                                        onmouseout="this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)'; this.style.transform='translateY(0)'"
                                        onclick="resetarFiltros()">
                                    üóëÔ∏è Limpar Filtros
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- M√©tricas Consolidadas - AJUSTAR CORES -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm stat-card card-hover">
                <div class="card-header" style="background: linear-gradient(135deg, var(--accent-olive) 0%, var(--accent-green) 100%); color: white;">
                    <h6 class="mb-0">üìà M√©tricas Consolidadas</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <!-- Total de Vendas (Valor) -->
                        <div class="col-xl-2 col-md-4 col-6 mb-3">
                            <div class="card bg-light border-0 h-100 card-hover">
                                <div class="card-body py-3">
                                    <h4 class="text-primary mb-1" id="totalValorVendas">R$ 0</h4>
                                    <small class="text-muted">Total Vendas (Valor)</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Total de NFs -->
                        <div class="col-xl-2 col-md-4 col-6 mb-3">
                            <div class="card bg-light border-0 h-100 card-hover">
                                <div class="card-body py-3">
                                    <h4 class="text-success mb-1" id="totalNFs">0</h4>
                                    <small class="text-muted">Total de NFs</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Total de Itens -->
                        <div class="col-xl-2 col-md-4 col-6 mb-3">
                            <div class="card bg-light border-0 h-100 card-hover">
                                <div class="card-body py-3">
                                    <h4 class="text-info mb-1" id="totalItens">0</h4>
                                    <small class="text-muted">Total de Itens</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ticket M√©dio -->
                        <div class="col-xl-2 col-md-4 col-6 mb-3">
                            <div class="card bg-light border-0 h-100 card-hover">
                                <div class="card-body py-3">
                                    <h4 class="text-warning mb-1" id="ticketMedio">R$ 0</h4>
                                    <small class="text-muted">Ticket M√©dio</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Consultor Top -->
                        <div class="col-xl-2 col-md-4 col-6 mb-3">
                            <div class="card bg-light border-0 h-100 card-hover">
                                <div class="card-body py-3">
                                    <h5 class="text-purple mb-1" id="topConsultor">N/A</h5>
                                    <small class="text-muted">Consultor Top</small>
                                    <div class="mt-1">
                                        <small class="text-success" id="topConsultorValor">R$ 0</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Revenda Top -->
                        <div class="col-xl-2 col-md-4 col-6 mb-3">
                            <div class="card bg-light border-0 h-100 card-hover">
                                <div class="card-body py-3">
                                    <h5 class="text-danger mb-1" id="topRevenda">N/A</h5>
                                    <small class="text-muted">Revenda Top</small>
                                    <div class="mt-1">
                                        <small class="text-success" id="topRevendaValor">R$ 0</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Distribui√ß√£o por Marca COM PORCENTAGENS -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header" style="background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%); color: white;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">üí∞ Distribui√ß√£o por Marca (Valor)</h6>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="togglePorcentagem" checked>
                                            <label class="form-check-label text-white" for="togglePorcentagem">
                                                Mostrar %
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-lg-8">
                                            <canvas id="chartMarcas" height="250"></canvas>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                                                <table class="table table-sm table-hover">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Marca</th>
                                                            <th class="text-end">Valor</th>
                                                            <th class="text-end">%</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="tabelaPorcentagemMarca">
                                                        <tr>
                                                            <td colspan="3" class="text-center text-muted">Carregando dados...</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Capilaridade Geral - AJUSTAR CORES -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm card-hover">
                <div class="card-header" style="background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-olive) 100%); color: white;">
                    <h6 class="mb-0">üåê Capilaridade Geral</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="card bg-light border-0">
                                <div class="card-body py-3">
                                    <h5 class="text-info mb-1" id="capClientes">0</h5>
                                    <small class="text-muted">Clientes</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-light border-0">
                                <div class="card-body py-3">
                                    <h5 class="text-success mb-1" id="capVendedores">0</h5>
                                    <small class="text-muted">Vendedores</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-light border-0">
                                <div class="card-body py-3">
                                    <h5 class="text-warning mb-1" id="capMarcas">0</h5>
                                    <small class="text-muted">Marcas</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row text-center mt-3">
                        <div class="col-6">
                            <div class="card bg-light border-0">
                                <div class="card-body py-3">
                                    <h5 class="text-secondary mb-1" id="capMediaItensNF">0.0</h5>
                                    <small class="text-muted">M√©dia Itens/NF</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-light border-0">
                                <div class="card-body py-3">
                                    <h5 class="text-secondary mb-1" id="capMediaValorNF">R$ 0</h5>
                                    <small class="text-muted">M√©dia Valor/NF</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NOVA: An√°lise Detalhada por Marca (CARDS REDUZIDOS) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm card-hover">
                <div class="card-header" style="background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%); color: white;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">üìä An√°lise Detalhada por Marca</h6>
                        <div class="col-md-4">
                            <select class="form-select" id="selecionarMarca" onchange="carregarAnaliseMarca(this.value)" style="border: 2px solid var(--primary-light);">
                                <option value="">Selecione uma marca</option>
                                {% for marca in marcas %}
                                <option value="{{ marca }}">{{ marca }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- M√©tricas da Marca Selecionada -->
                    <div class="row mb-4" id="metricasMarca">
                        <div class="col-12 text-center py-4">
                            <div class="display-1 text-muted mb-3">üè∑Ô∏è</div>
                            <h4 class="text-muted">Selecione uma marca para ver a an√°lise detalhada</h4>
                            <p class="text-muted mt-2">Clique no dropdown acima para escolher uma marca</p>
                        </div>
                    </div>
                    
                    <!-- Conte√∫do da An√°lise da Marca (aparece quando selecionada) -->
                    <div id="conteudoAnaliseMarca" style="display: none;">
                        <!-- M√©tricas Principais da Marca (CARDS REDUZIDOS) -->
                        <div class="row mb-3">
                            <div class="col-xl-3 col-lg-6 mb-2">
                                <div class="card bg-light border-0 h-100 card-hover">
                                    <div class="card-body text-center py-2">
                                        <div class="h4 text-primary mb-1" id="marcaTotalFaturamento">R$ 0</div>
                                        <small class="text-muted">Total Faturamento</small>
                                        <div class="mt-1">
                                            <small class="text-muted" id="marcaPercentualTotal">0% do total</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-xl-3 col-lg-6 mb-2">
                                <div class="card bg-light border-0 h-100 card-hover">
                                    <div class="card-body text-center py-2">
                                        <div class="h4 text-success mb-1" id="marcaTicketMedio">R$ 0</div>
                                        <small class="text-muted">Ticket M√©dio/Cliente</small>
                                        <div class="mt-1">
                                            <small class="text-muted">Valor m√©dio por comprador</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-xl-3 col-lg-6 mb-2">
                                <div class="card bg-light border-0 h-100 card-hover">
                                    <div class="card-body text-center py-2">
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="h5 text-info mb-1" id="marcaTotalClientes">0</div>
                                                <small class="text-muted">Clientes</small>
                                            </div>
                                            <div class="col-6">
                                                <div class="h5 text-warning mb-1" id="marcaCompradores">0</div>
                                                <small class="text-muted">Compradores</small>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">Penetra√ß√£o</small>
                                            <div class="progress" style="height: 8px;">
                                                <div id="marcaPenetracaoBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-muted" id="marcaPenetracaoPercent">0%</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-xl-3 col-lg-6 mb-2">
                                <div class="card bg-light border-0 h-100 card-hover">
                                    <div class="card-body text-center py-2">
                                        <div class="h4 text-purple mb-1" id="marcaVendasCros">R$ 0</div>
                                        <small class="text-muted">Vendas CROS</small>
                                        <div class="mt-1">
                                            <small class="text-muted" id="marcaPercentualCros">0% do faturamento</small>
                                        </div>
                                        <div class="mt-1">
                                            <small class="text-muted" id="marcaNfsCros">0 NFs mistas</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gr√°ficos da Marca -->
                        <div class="row mb-3">
                            <!-- Gr√°fico: Clientes vs Compradores -->
                            <div class="col-lg-6 mb-3">
                                <div class="card h-100 card-hover">
                                    <div class="card-header bg-light py-2">
                                        <h6 class="mb-0">üë• Clientes vs Compradores</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <canvas id="chartClientesCompradores" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gr√°fico: Top 10 Produtos por Valor -->
                            <div class="col-lg-6 mb-3">
                                <div class="card h-100 card-hover">
                                    <div class="card-header bg-light py-2">
                                        <h6 class="mb-0">üèÜ Top 10 Produtos (por Valor)</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <canvas id="chartTopProdutos" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabela Detalhada de Top Produtos (compacta) -->
                        <!-- Tabela Detalhada de Top Produtos SEM SCROLL -->
<div class="row">
    <div class="col-12">
        <div class="card card-hover">
            <div class="card-header bg-light py-2">
                <h6 class="mb-0">üìã Detalhamento Top Produtos</h6>
            </div>
            <div class="card-body p-2">
                <!-- REMOVIDO: max-height e overflow-y -->
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Produto</th>
                                <th class="text-end">Qtd</th>
                                <th class="text-end">Valor Unit.</th>
                                <th class="text-end">Valor Total</th>
                                <th class="text-end">% da Marca</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaTopProdutosDetalhado">
                            <tr>
                                <td colspan="6" class="text-center text-muted py-3">
                                    Selecione uma marca para ver os produtos
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√£o Voltar - AJUSTAR CORES -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="{{ url_for('index') }}" class="btn" style="background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-olive) 100%); color: white; font-weight: 600; border: none; padding: 10px 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 1.1rem;"
                onmouseover="this.style.boxShadow='0 4px 12px rgba(100, 148, 28, 0.4)'; this.style.transform='translateY(-2px)'" 
                onmouseout="this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)'; this.style.transform='translateY(0)'">
                üè† Voltar para P√°gina Inicial
            </a>
        </div>
    </div>
</div>

<!-- ADICIONAR ESTE CSS NO FINAL DO BLOCO -->
<style>
    /* Responsividade para escala 90% */
    @media (max-width: 768px) {
        .analise-container {
            transform: scale(1);
            width: 100%;
            margin-left: 0;
            margin-top: 0;
        }
    }
    
    /* Melhorar visibilidade dos bot√µes em geral */
    .btn {
        transition: all 0.3s ease !important;
    }
    
    .form-select:focus, .form-control:focus {
        border-color: var(--accent-yellow) !important;
        box-shadow: 0 0 0 0.25rem rgba(206, 240, 5, 0.25) !important;
    }
</style>

<!-- CSS local -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/sweetalert2.min.css') }}">

<!-- COM CDN (para teste r√°pido) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>




<script>
// Vari√°veis globais
let vendasFiltradas = [];
let paginaAtual = 1;
let itensPorPagina = 50;
let graficoMarcas = null;
let graficoClientesCompradores = null;
let graficoTopProdutos = null;

// Inicializar dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log("üîß Inicializando dashboard de an√°lise...");
    carregarDadosIniciais();
    
    // Evento para toggle de porcentagem
    document.getElementById('togglePorcentagem').addEventListener('change', function() {
        if (graficoMarcas) {
            atualizarGraficoMarcasComPorcentagem();
        }
    });
});

// Carregar dados iniciais
function carregarDadosIniciais() {
    // Carregar m√©tricas usando a rota existente
    fetch('/api/metricas-vendas')
    .then(response => response.json())
    .then(data => {
        console.log("üìà M√©tricas iniciais:", data);
        atualizarMetricasIniciais(data);
    })
    .catch(error => {
        console.error("‚ùå Erro ao carregar m√©tricas:", error);
    });
    
    // Carregar capilaridade
    carregarCapilaridade();
}

// Atualizar m√©tricas iniciais
function atualizarMetricasIniciais(data) {
    // Total de vendas
    if (data.totais_por_nf) {
        document.getElementById('totalValorVendas').textContent = 
            'R$ ' + formatarNumero(data.totais_por_nf.total_valor || 0);
        document.getElementById('totalNFs').textContent = data.totais_por_nf.total_nfs || 0;
        document.getElementById('totalItens').textContent = data.totais_por_nf.total_itens || 0;
        document.getElementById('ticketMedio').textContent = 
            'R$ ' + formatarNumero(data.totais_por_nf.media_valor_por_nf || 0);
    }
    
    // Consultor top
    if (data.vendedores?.maior_valor) {
        document.getElementById('topConsultor').textContent = 
            data.vendedores.maior_valor.nome?.substring(0, 20) || 'N/A';
        document.getElementById('topConsultorValor').textContent = 
            'R$ ' + formatarNumero(data.vendedores.maior_valor.valor || 0);
    }
    
    // Revenda top
    if (data.clientes?.maior_valor) {
        document.getElementById('topRevenda').textContent = 
            data.clientes.maior_valor.nome?.substring(0, 20) || 'N/A';
        document.getElementById('topRevendaValor').textContent = 
            'R$ ' + formatarNumero(data.clientes.maior_valor.valor || 0);
    }
    
    // Criar gr√°fico de marcas COM PORCENTAGENS
    if (data.marcas_por_nf && data.marcas_por_nf.length > 0) {
        criarGraficoMarcasComPorcentagem(data.marcas_por_nf, data.totais_por_nf?.total_valor || 0);
    }
}

// Fun√ß√£o para aplicar filtros
function aplicarFiltros() {
    console.log("üîç Aplicando filtros...");
    carregarMetricasComFiltros();
    carregarCapilaridadeComFiltros();
    
    // Resetar an√°lise de marca
    document.getElementById('selecionarMarca').value = '';
    document.getElementById('conteudoAnaliseMarca').style.display = 'none';
    document.getElementById('metricasMarca').innerHTML = `
        <div class="col-12 text-center py-4">
            <div class="display-1 text-muted mb-3">üè∑Ô∏è</div>
            <h4 class="text-muted">Selecione uma marca para ver a an√°lise detalhada</h4>
            <p class="text-muted mt-2">Clique no dropdown acima para escolher uma marca</p>
        </div>
    `;
}

// Carregar m√©tricas com filtros
function carregarMetricasComFiltros() {
    const filtros = obterFiltros();
    console.log("üìä Carregando m√©tricas com filtros:", filtros);
    
    // 1. Primeiro pega os totais b√°sicos da rota /api/vendas-filtradas
    fetch('/api/vendas-filtradas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            ...filtros,
            page: 1,
            per_page: 1
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log("üìà Dados b√°sicos filtrados:", data);
        
        // Atualizar m√©tricas b√°sicas
        document.getElementById('totalValorVendas').textContent = 
            'R$ ' + formatarNumero(data.total_valor || 0);
        document.getElementById('totalNFs').textContent = data.total_vendas || 0;
        document.getElementById('totalItens').textContent = data.total_quantidade || 0;
        
        // Calcular ticket m√©dio
        const ticketMedio = data.total_valor / (data.total_vendas || 1);
        document.getElementById('ticketMedio').textContent = 
            'R$ ' + formatarNumero(ticketMedio);
        
        // 2. Agora busca os tops e distribui√ß√£o por marca
        return fetch('/api/metricas-vendas-filtradas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filtros)
        });
    })
    .then(response => response.json())
    .then(data => {
        console.log("üèÜ Dados tops filtrados:", data);
        
        // Top consultor
        if (data.vendedores?.maior_valor?.nome) {
            document.getElementById('topConsultor').textContent = 
                data.vendedores.maior_valor.nome.length > 20 ? 
                data.vendedores.maior_valor.nome.substring(0, 20) + '...' : 
                data.vendedores.maior_valor.nome;
            document.getElementById('topConsultorValor').textContent = 
                'R$ ' + formatarNumero(data.vendedores.maior_valor.valor || 0);
        } else {
            document.getElementById('topConsultor').textContent = 'N/A';
            document.getElementById('topConsultorValor').textContent = 'R$ 0';
        }
        
        // Top revenda
        if (data.clientes?.maior_valor?.nome) {
            document.getElementById('topRevenda').textContent = 
                data.clientes.maior_valor.nome.length > 20 ? 
                data.clientes.maior_valor.nome.substring(0, 20) + '...' : 
                data.clientes.maior_valor.nome;
            document.getElementById('topRevendaValor').textContent = 
                'R$ ' + formatarNumero(data.clientes.maior_valor.valor || 0);
        } else {
            document.getElementById('topRevenda').textContent = 'N/A';
            document.getElementById('topRevendaValor').textContent = 'R$ 0';
        }
        
        // Atualizar gr√°fico de marcas COM PORCENTAGENS
        const totalVendas = parseFloat(document.getElementById('totalValorVendas').textContent.replace('R$ ', '').replace('.', '').replace(',', '.'));
        if (data.marcas_por_nf && data.marcas_por_nf.length > 0) {
            criarGraficoMarcasComPorcentagem(data.marcas_por_nf, totalVendas || 0);
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao carregar m√©tricas com filtros:', error);
    });
}

// Carregar capilaridade com filtros
function carregarCapilaridadeComFiltros() {
    const filtros = obterFiltros();
    
    fetch('/api/capilaridade-vendas-filtradas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(filtros)
    })
    .then(response => response.json())
    .then(data => {
        console.log("üåê Dados de capilaridade com filtros:", data);
        
        // Atualizar m√©tricas de capilaridade
        if (data.estatisticas_gerais) {
            document.getElementById('capClientes').textContent = data.estatisticas_gerais.total_clientes || 0;
            document.getElementById('capVendedores').textContent = data.estatisticas_gerais.total_vendedores || 0;
            document.getElementById('capMarcas').textContent = data.estatisticas_gerais.total_marcas || 0;
            document.getElementById('capMediaItensNF').textContent = 
                (data.estatisticas_gerais.media_itens_por_nf || 0).toFixed(1);
            document.getElementById('capMediaValorNF').textContent = 
                'R$ ' + formatarNumero(data.estatisticas_gerais.media_valor_por_nf || 0);
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao carregar capilaridade com filtros:', error);
    });
}

// Carregar an√°lise de marca espec√≠fica
function carregarAnaliseMarca(marca) {
    if (!marca) {
        document.getElementById('conteudoAnaliseMarca').style.display = 'none';
        document.getElementById('metricasMarca').innerHTML = `
            <div class="col-12 text-center py-4">
                <div class="display-1 text-muted mb-3">üè∑Ô∏è</div>
                <h4 class="text-muted">Selecione uma marca para ver a an√°lise detalhada</h4>
                <p class="text-muted mt-2">Clique no dropdown acima para escolher uma marca</p>
            </div>
        `;
        return;
    }
    
    console.log(`üìä Carregando an√°lise da marca: ${marca}`);
    
    // Obter filtros atuais
    const filtros = obterFiltros();
    filtros.marca_especifica = marca;
    
    // Usar nova rota para an√°lise detalhada da marca
    fetch('/api/analise-detalhada-marca', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(filtros)
    })
    .then(response => response.json())
    .then(data => {
        console.log(`‚úÖ Dados detalhados da marca ${marca}:`, data);
        
        // Mostrar conte√∫do
        document.getElementById('conteudoAnaliseMarca').style.display = 'block';
        document.getElementById('metricasMarca').innerHTML = `
            <div class="col-12 mb-2">
                <div class="card bg-primary text-white py-2">
                    <div class="card-body text-center py-1">
                        <h4 class="mb-0">${marca}</h4>
                        <p class="mb-0" style="font-size: 0.9rem;">An√°lise detalhada com filtros aplicados</p>
                    </div>
                </div>
            </div>
        `;
        
        // Atualizar m√©tricas da marca
        if (data.dados_gerais) {
            atualizarMetricasMarca(data.dados_gerais, data);
        }
        
        // Criar gr√°ficos
        if (data.clientes_compradores) {
            criarGraficoClientesCompradores(data.clientes_compradores);
        }
        
        if (data.top_produtos && data.top_produtos.length > 0) {
            criarGraficoTopProdutos(data.top_produtos);
            atualizarTabelaTopProdutosDetalhado(data.top_produtos, data.dados_gerais?.total_valor || 0);
        }
        
    })
    .catch(error => {
        console.error(`‚ùå Erro ao carregar an√°lise da marca ${marca}:`, error);
        document.getElementById('metricasMarca').innerHTML = `
            <div class="col-12 text-center py-4">
                <p class="text-danger">Erro ao carregar dados da marca</p>
                <p class="text-muted">${error.message}</p>
            </div>
        `;
    });
}

// Atualizar m√©tricas da marca
function atualizarMetricasMarca(dados, dataCompleta) {
    // Total faturamento
    const totalFaturamento = dados.total_valor || 0;
    const totalGeral = parseFloat(document.getElementById('totalValorVendas').textContent.replace('R$ ', '').replace('.', '').replace(',', '.'));
    const percentualTotal = totalGeral > 0 ? (totalFaturamento / totalGeral * 100).toFixed(1) : 0;
    
    document.getElementById('marcaTotalFaturamento').textContent = 'R$ ' + formatarNumero(totalFaturamento);
    document.getElementById('marcaPercentualTotal').textContent = percentualTotal + '% do total';
    
    // Ticket m√©dio
    const ticketMedio = dados.ticket_medio_cliente || 0;
    document.getElementById('marcaTicketMedio').textContent = 'R$ ' + formatarNumero(ticketMedio);
    
    // Clientes vs Compradores
    const totalClientes = dataCompleta.estatisticas_clientes?.total_clientes || 0;
    const compradoresMarca = dados.clientes_compradores || 0;
    const penetracao = totalClientes > 0 ? (compradoresMarca / totalClientes * 100).toFixed(1) : 0;
    
    document.getElementById('marcaTotalClientes').textContent = totalClientes;
    document.getElementById('marcaCompradores').textContent = compradoresMarca;
    document.getElementById('marcaPenetracaoBar').style.width = penetracao + '%';
    document.getElementById('marcaPenetracaoPercent').textContent = penetracao + '%';
    
    // Vendas CROS
    const vendasCros = dados.vendas_cros?.valor_total || 0;
    const nfsCros = dados.vendas_cros?.total_nfs || 0;
    const percentualCros = totalFaturamento > 0 ? (vendasCros / totalFaturamento * 100).toFixed(1) : 0;
    
    document.getElementById('marcaVendasCros').textContent = 'R$ ' + formatarNumero(vendasCros);
    document.getElementById('marcaPercentualCros').textContent = percentualCros + '% do faturamento';
    document.getElementById('marcaNfsCros').textContent = nfsCros + ' NFs mistas';
}

// Criar gr√°fico de marcas COM PORCENTAGENS
function criarGraficoMarcasComPorcentagem(dadosMarcas, totalVendas) {
    const ctx = document.getElementById('chartMarcas');
    if (!ctx) {
        console.error("‚ùå Elemento chartMarcas n√£o encontrado!");
        return;
    }
    
    // Destruir gr√°fico anterior se existir
    if (graficoMarcas) {
        graficoMarcas.destroy();
    }
    
    // Ordenar por valor (decrescente)
    dadosMarcas.sort((a, b) => (b.valor || 0) - (a.valor || 0));
    
    // Preparar dados
    const labels = dadosMarcas.map(marca => marca.marca || 'Desconhecida');
    const valores = dadosMarcas.map(marca => marca.valor || 0);
    const porcentagens = totalVendas > 0 ? 
        valores.map(valor => ((valor / totalVendas) * 100).toFixed(1)) : 
        valores.map(() => '0.0');
    
    // Atualizar tabela de porcentagens
    atualizarTabelaPorcentagemMarca(dadosMarcas, totalVendas);
    
    // Cores do dashboard original
    const cores = [
        '#28a745', '#20c997', '#17a2b8', '#007bff', '#6f42c1',
        '#e83e8c', '#fd7e14', '#ffc107', '#dc3545', '#343a40'
    ];
    
    // Configurar tooltip com ou sem porcentagem
    const showPercentage = document.getElementById('togglePorcentagem').checked;
    
    graficoMarcas = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.slice(0, 10), // Mostrar apenas top 10
            datasets: [{
                label: 'Valor (R$)',
                data: valores.slice(0, 10),
                backgroundColor: cores.slice(0, Math.min(valores.length, 10)),
                borderColor: cores.slice(0, Math.min(valores.length, 10)),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const valor = context.raw;
                            const porcentagem = showPercentage ? 
                                ` (${((valor / totalVendas) * 100).toFixed(1)}%)` : '';
                            return `R$ ${formatarNumero(valor)}${porcentagem}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + formatarNumero(value);
                        }
                    }
                }
            }
        }
    });
}

// Atualizar tabela de porcentagem de marcas
function atualizarTabelaPorcentagemMarca(dadosMarcas, totalVendas) {
    const tbody = document.getElementById('tabelaPorcentagemMarca');
    let html = '';
    
    // Ordenar por valor (decrescente)
    dadosMarcas.sort((a, b) => (b.valor || 0) - (a.valor || 0));
    
    dadosMarcas.slice(0, 10).forEach((marca, index) => {
        const valor = marca.valor || 0;
        const porcentagem = totalVendas > 0 ? ((valor / totalVendas) * 100).toFixed(1) : '0.0';
        
        html += `
            <tr>
                <td>
                    <span class="badge" style="background-color: #28a745; color: white; padding: 3px 8px; margin-right: 8px;">
                        ${index + 1}
                    </span>
                    ${marca.marca || 'Desconhecida'}
                </td>
                <td class="text-end">
                    <strong class="text-success">R$ ${formatarNumero(valor)}</strong>
                </td>
                <td class="text-end">
                    <span class="badge bg-info">${porcentagem}%</span>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Atualizar gr√°fico de marcas com toggle de porcentagem
function atualizarGraficoMarcasComPorcentagem() {
    if (graficoMarcas) {
        graficoMarcas.destroy();
        // Recriar o gr√°fico com as configura√ß√µes atuais
        carregarMetricasComFiltros();
    }
}

// Criar gr√°fico de clientes vs compradores
function criarGraficoClientesCompradores(dados) {
    const ctx = document.getElementById('chartClientesCompradores');
    if (!ctx) return;
    
    // Destruir gr√°fico anterior se existir
    if (graficoClientesCompradores) {
        graficoClientesCompradores.destroy();
    }
    
    const totalClientes = dados.total_clientes || 0;
    const compradores = dados.compradores_marca || 0;
    const naoCompradores = totalClientes - compradores;
    
    graficoClientesCompradores = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Comparativo'],
            datasets: [
                {
                    label: 'Total de Clientes',
                    data: [totalClientes],
                    backgroundColor: '#17a2b8',
                    borderColor: '#117a8b',
                    borderWidth: 1
                },
                {
                    label: 'Compradores da Marca',
                    data: [compradores],
                    backgroundColor: '#28a745',
                    borderColor: '#1e7e34',
                    borderWidth: 1
                },
                {
                    label: 'N√£o Compradores',
                    data: [naoCompradores],
                    backgroundColor: '#6c757d',
                    borderColor: '#545b62',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Quantidade de Clientes'
                    }
                }
            }
        }
    });
}

// Criar gr√°fico de top 10 produtos por valor
function criarGraficoTopProdutos(produtos) {
    const ctx = document.getElementById('chartTopProdutos');
    if (!ctx) return;
    
    // Destruir gr√°fico anterior se existir
    if (graficoTopProdutos) {
        graficoTopProdutos.destroy();
    }
    
    // Ordenar por valor (decrescente) e pegar top 10
    produtos.sort((a, b) => (b.valor_total || 0) - (a.valor_total || 0));
    const top10 = produtos.slice(0, 10);
    
    // Preparar dados
    const labels = top10.map(prod => {
        const nome = prod.produto || prod.descricao || 'Desconhecido';
        return nome.length > 15 ? nome.substring(0, 15) + '...' : nome;
    });
    const valores = top10.map(prod => prod.valor_total || 0);
    const quantidades = top10.map(prod => prod.quantidade || 0);
    
    // Cores
    const cores = [
        '#28a745', '#20c997', '#17a2b8', '#007bff', '#6f42c1',
        '#e83e8c', '#fd7e14', '#ffc107', '#dc3545', '#343a40'
    ];
    
    graficoTopProdutos = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Valor Total (R$)',
                data: valores,
                backgroundColor: cores.slice(0, valores.length),
                borderColor: cores.slice(0, valores.length),
                borderWidth: 1,
                yAxisID: 'y'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const produto = top10[context.dataIndex];
                            return [
                                `Produto: ${produto.produto || produto.descricao}`,
                                `Valor: R$ ${formatarNumero(context.raw)}`,
                                `Quantidade: ${produto.quantidade || 0}`,
                                `% da marca: ${produto.percentual_marca?.toFixed(1) || '0.0'}%`
                            ];
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Valor (R$)'
                    },
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + formatarNumero(value);
                        }
                    }
                }
            }
        }
    });
}

// Atualizar tabela detalhada de top produtos
function atualizarTabelaTopProdutosDetalhado(produtos, totalMarca) {
    const tbody = document.getElementById('tabelaTopProdutosDetalhado');
    let html = '';
    
    // Ordenar por valor (decrescente)
    produtos.sort((a, b) => (b.valor_total || 0) - (a.valor_total || 0));
    
    produtos.slice(0, 10).forEach((prod, index) => {
        const valorTotal = prod.valor_total || 0;
        const percentualMarca = totalMarca > 0 ? ((valorTotal / totalMarca) * 100).toFixed(1) : '0.0';
        const valorUnitario = prod.quantidade > 0 ? (valorTotal / prod.quantidade) : 0;
        const nomeProduto = prod.produto || prod.descricao || 'Desconhecido';
        
        html += `
            <tr>
                <td>${index + 1}</td>
                <td title="${nomeProduto}">
                    ${nomeProduto.length > 30 ? nomeProduto.substring(0, 80) : nomeProduto}
                </td>
                <td class="text-end">${prod.quantidade || 0}</td>
                <td class="text-end">R$ ${formatarNumero(valorUnitario)}</td>
                <td class="text-end">
                    <strong class="text-success">R$ ${formatarNumero(valorTotal)}</strong>
                </td>
                <td class="text-end">
                    <span class="badge bg-info">${percentualMarca}%</span>
                </td>
            </tr>
        `;
    });
    
    if (html === '') {
        html = `
            <tr>
                <td colspan="6" class="text-center text-muted py-3">
                    Nenhum produto encontrado para esta marca
                </td>
            </tr>
        `;
    }
    
    tbody.innerHTML = html;
}

// Fun√ß√µes auxiliares
function formatarNumero(valor) {
    return parseFloat(valor || 0).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function obterFiltros() {
    return {
        cliente: document.getElementById('filtroCliente').value,
        vendedor: document.getElementById('filtroVendedor').value,
        marca: document.getElementById('filtroMarca').value,
        equipe: document.getElementById('filtroEquipe').value,
        familia: document.getElementById('filtroFamilia').value,
        data_inicio: document.getElementById('filtroDataInicio').value,
        data_fim: document.getElementById('filtroDataFim').value,
        sort_by: 'data_emissao',
        sort_order: 'desc'
    };
}

function resetarFiltros() {
    document.getElementById('filtroCliente').value = 'todos';
    document.getElementById('filtroVendedor').value = 'todos';
    document.getElementById('filtroMarca').value = 'todos';
    document.getElementById('filtroEquipe').value = 'todos';
    document.getElementById('filtroFamilia').value = 'todos';
    document.getElementById('filtroDataInicio').value = '{{ min_date }}';
    document.getElementById('filtroDataFim').value = '{{ max_date }}';
    aplicarFiltros();
}

function carregarCapilaridade() {
    fetch('/api/capilaridade-vendas')
    .then(response => response.json())
    .then(data => {
        console.log("üåê Dados de capilaridade:", data);
        
        // Atualizar m√©tricas de capilaridade
        if (data.estatisticas_gerais) {
            document.getElementById('capClientes').textContent = data.estatisticas_gerais.total_clientes || 0;
            document.getElementById('capVendedores').textContent = data.estatisticas_gerais.total_vendedores || 0;
            document.getElementById('capMarcas').textContent = data.estatisticas_gerais.total_marcas || 0;
            document.getElementById('capMediaItensNF').textContent = 
                (data.estatisticas_gerais.media_itens_por_nf || 0).toFixed(1);
            document.getElementById('capMediaValorNF').textContent = 
                'R$ ' + formatarNumero(data.estatisticas_gerais.media_valor_por_nf || 0);
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao carregar capilaridade:', error);
    });
}

function exportarParaExcel() {
    const filtros = obterFiltros();
    const params = new URLSearchParams();
    
    Object.keys(filtros).forEach(key => {
        if (filtros[key]) {
            params.append(key, filtros[key]);
        }
    });
    
    window.location.href = `/exportar-vendas-filtradas?${params.toString()}`;
}

// Exportar para Imagem - VERS√ÉO COM ESPERA DE RENDERIZA√á√ÉO
async function exportarParaImagem() {
    console.log("üì∏ Exportando an√°lise da marca...");
    
    // Verificar se tem marca selecionada
    const marcaSelecionada = document.querySelector('#selecionarMarca').value;
    if (!marcaSelecionada) {
        Swal.fire({
            icon: 'info',
            title: 'Selecione uma marca',
            text: 'Escolha uma marca no dropdown acima para ver a an√°lise'
        });
        return;
    }
    
    // Verificar se a an√°lise est√° vis√≠vel
    const analiseSection = document.getElementById('conteudoAnaliseMarca');
    if (!analiseSection || analiseSection.style.display === 'none') {
        Swal.fire({
            icon: 'warning',
            title: 'An√°lise n√£o vis√≠vel',
            text: 'Clique em "Aplicar Filtros" ou selecione outra marca'
        });
        return;
    }
    
    // Loading
    Swal.fire({
        title: 'Preparando exporta√ß√£o...',
        html: 'Renderizando gr√°ficos...',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => Swal.showLoading()
    });
    
    // 1. FUN√á√ÉO PARA FOR√áAR RENDERIZA√á√ÉO DOS GR√ÅFICOS
    async function renderizarGraficos() {
        return new Promise((resolve) => {
            // Atualizar todos os gr√°ficos vis√≠veis
            const graficos = [
                'chartClientesCompradores',
                'chartTopProdutos'
            ];
            
            let graficosAtualizados = 0;
            const totalGraficos = graficos.length;
            
            graficos.forEach(chartId => {
                const canvas = document.getElementById(chartId);
                if (canvas) {
                    const chart = Chart.getChart(canvas);
                    if (chart) {
                        // For√ßar renderiza√ß√£o
                        chart.update('none');
                        
                        // Garantir que o canvas tenha dados renderizados
                        const context = canvas.getContext('2d');
                        if (context) {
                            // Pequeno delay para renderiza√ß√£o
                            setTimeout(() => {
                                graficosAtualizados++;
                                if (graficosAtualizados === totalGraficos) {
                                    resolve();
                                }
                            }, 200);
                        } else {
                            graficosAtualizados++;
                        }
                    } else {
                        graficosAtualizados++;
                    }
                } else {
                    graficosAtualizados++;
                }
            });
            
            // Fallback se n√£o encontrar gr√°ficos
            if (totalGraficos === 0) {
                setTimeout(resolve, 300);
            }
        });
    }
    
    // 2. RENDERIZAR GR√ÅFICOS PRIMEIRO
    await renderizarGraficos();
    
    // Atualizar mensagem
    Swal.update({
        title: 'Gerando imagem...',
        html: 'Capturando tela...'
    });
    
    // 3. PEGAR O CARD COMPLETO
    const cardAnaliseCompleto = document.querySelector('.card:has(#conteudoAnaliseMarca)');
    
    if (!cardAnaliseCompleto) {
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'N√£o foi poss√≠vel encontrar a se√ß√£o de an√°lise'
        });
        return;
    }
    
    // 4. CRIAR UM CONTAINER TEMPOR√ÅRIO PARA CAPTURA
    const tempContainer = document.createElement('div');
    tempContainer.id = 'temp-export-container';
    tempContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: ${cardAnaliseCompleto.offsetWidth}px;
        z-index: 99999;
        background: white;
        padding: 20px;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
    `;
    
    // 5. CLONAR O CONTE√öDO DO CARD (isso garante que os gr√°ficos j√° renderizados sejam copiados)
    const cardClone = cardAnaliseCompleto.cloneNode(true);
    
    // 6. COPIAR OS CANVAS DOS GR√ÅFICOS (IMPORTANTE!)
    const canvasElements = cardAnaliseCompleto.querySelectorAll('canvas');
    const canvasClones = cardClone.querySelectorAll('canvas');
    
    canvasElements.forEach((originalCanvas, index) => {
        const cloneCanvas = canvasClones[index];
        if (originalCanvas && cloneCanvas) {
            // Copiar o conte√∫do do canvas original para o clone
            cloneCanvas.width = originalCanvas.width;
            cloneCanvas.height = originalCanvas.height;
            
            const originalContext = originalCanvas.getContext('2d');
            const cloneContext = cloneCanvas.getContext('2d');
            
            if (originalContext && cloneContext) {
                // Criar uma imagem do canvas original e desenhar no clone
                const imageData = originalCanvas.toDataURL();
                const img = new Image();
                img.src = imageData;
                img.onload = function() {
                    cloneContext.clearRect(0, 0, cloneCanvas.width, cloneCanvas.height);
                    cloneContext.drawImage(img, 0, 0);
                };
            }
        }
    });
    
    // 7. REMOVER ELEMENTOS INTERATIVOS DO CLONE
    const elementosInterativos = cardClone.querySelectorAll(
        'button, select, .form-select, .form-check-input, .dropdown-toggle'
    );
    elementosInterativos.forEach(el => el.remove());
    
    // 8. AJUSTAR ESTILOS DO CLONE
    cardClone.style.width = '100%';
    cardClone.style.margin = '0';
    cardClone.style.boxShadow = 'none';
    cardClone.style.border = '1px solid #dee2e6';
    
    // 9. ADICIONAR AO CONTAINER TEMPOR√ÅRIO
    tempContainer.appendChild(cardClone);
    document.body.appendChild(tempContainer);
    
    // 10. PEQUENA PAUSA PARA GARANTIR RENDERIZA√á√ÉO
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // 11. CAPTURAR COM html2canvas
    html2canvas(tempContainer, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        logging: true,
        allowTaint: true,
        onclone: function(clonedDoc, element) {
            // Garantir que tudo esteja vis√≠vel no clone
            element.style.width = '100%';
            element.style.height = 'auto';
            
            // Remover overflow das tabelas
            const tables = element.querySelectorAll('.table-responsive');
            tables.forEach(table => {
                table.style.overflow = 'visible';
                table.style.maxHeight = 'none';
            });
            
            // Ajustar canvas no clone
            const canvases = element.querySelectorAll('canvas');
            canvases.forEach(canvas => {
                canvas.style.width = '100%';
                canvas.style.height = '100%';
            });
        }
    }).then(canvas => {
        console.log("‚úÖ Captura realizada com sucesso!");
        
        // 12. REMOVER CONTAINER TEMPOR√ÅRIO
        document.body.removeChild(tempContainer);
        
        // 13. CRIAR E BAIXAR IMAGEM
        const link = document.createElement('a');
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
        const nomeMarca = marcaSelecionada.replace(/[^a-zA-Z0-9]/g, '_');
        link.download = `analise_${nomeMarca}_${timestamp}.png`;
        link.href = canvas.toDataURL('image/png');
        
        // 14. FECHAR LOADING E BAIXAR
        Swal.close();
        link.click();
        
        // 15. CONFIRMA√á√ÉO
        Swal.fire({
            icon: 'success',
            title: '‚úÖ Imagem salva!',
            html: `
                <div style="text-align: center;">
                    <p>An√°lise da <strong>${marcaSelecionada}</strong> exportada com sucesso</p>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        Dimens√µes: ${canvas.width} √ó ${canvas.height} pixels
                    </p>
                </div>
            `,
            showConfirmButton: true,
            confirmButtonText: 'OK',
            timer: 3000
        });
        
    }).catch(error => {
        console.error('‚ùå Erro na captura:', error);
        
        // Limpar container tempor√°rio em caso de erro
        if (document.getElementById('temp-export-container')) {
            document.body.removeChild(tempContainer);
        }
        
        Swal.fire({
            icon: 'error',
            title: 'Erro na exporta√ß√£o',
            text: 'N√£o foi poss√≠vel gerar a imagem. Tente novamente.',
            footer: '<small>Se o problema persistir, tente atualizar a p√°gina</small>'
        });
    });
}

</script>

<style>
    /* ESTILOS M√çNIMOS para an√°lise de vendas - N√ÉO AFETA NAVBAR */
    
    /* Apenas para cards espec√≠ficos deste template */
    .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
    }
    
    /* Apenas para os gr√°ficos e tabelas DESTE template */
    #chartMarcas,
    #chartClientesCompradores,
    #chartTopProdutos {
        max-height: 250px;
    }
    
    /* Apenas para tabelas DESTE template */
    #tabelaPorcentagemMarca th,
    #tabelaTopProdutosDetalhado th {
        font-weight: 600;
        background-color: #f8f9fa;
        font-size: 0.85rem;
        padding: 8px 10px;
    }
    
    #tabelaTopProdutosDetalhado td {
        font-size: 0.85rem;
        padding: 6px 8px;
    }
    
    /* Ajustes para cards reduzidos */
    .card-body.py-2 {
        padding-top: 0.75rem !important;
        padding-bottom: 0.75rem !important;
    }
    
    .card-body.py-1 {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
        #tabelaPorcentagemMarca,
        #tabelaTopProdutosDetalhado {
            font-size: 0.8rem;
        }
        
        .h4 {
            font-size: 1.5rem;
        }
        
        .h5 {
            font-size: 1.25rem;
        }
        
        .card-body.py-2 {
            padding: 0.5rem !important;
        }
    }
</style>
{% endblock %}